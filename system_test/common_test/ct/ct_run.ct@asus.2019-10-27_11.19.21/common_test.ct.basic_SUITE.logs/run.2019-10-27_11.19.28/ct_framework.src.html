<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>/home/pi/erlang/otp/lib/common_test/src/ct_framework.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2004-2018. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%% Common Test Framework callback module.</i>
<a name="22"/>   22: <i>%%%</i>
<a name="23"/>   23: <i>%%% This module exports framework callback functions which are</i>
<a name="24"/>   24: <i>%%% called from the test_server.</i>
<a name="25"/>   25: 
<a name="26"/>   26: <b>-module</b>(ct_framework).
<a name="27"/>   27: 
<a name="28"/>   28: <b>-export</b>([init_tc/3, end_tc/3, end_tc/4, get_suite/2, get_all_cases/1]).
<a name="29"/>   29: <b>-export</b>([report/2, warn/1, error_notification/4]).
<a name="30"/>   30: 
<a name="31"/>   31: <b>-export</b>([get_log_dir/0, get_logopts/0, format_comment/1, get_html_wrapper/4]).
<a name="32"/>   32: 
<a name="33"/>   33: <b>-export</b>([error_in_suite/1, init_per_suite/1, end_per_suite/1,
<a name="34"/>   34: 	 init_per_group/2, end_per_group/2]).
<a name="35"/>   35: 
<a name="36"/>   36: <b>-include</b>(&quot;ct.hrl&quot;).
<a name="37"/>   37: <b>-include</b>(&quot;ct_event.hrl&quot;).
<a name="38"/>   38: <b>-include</b>(&quot;ct_util.hrl&quot;).
<a name="39"/>   39: 
<a name="40"/>   40: <b>-define</b>(val(Key, List), proplists:get_value(Key, List)). 
<a name="41"/>   41: <b>-define</b>(val(Key, List, Def), proplists:get_value(Key, List, Def)).
<a name="42"/>   42: <b>-define</b>(rev(L), lists:reverse(L)).
<a name="43"/>   43: 
<a name="44"/>   44: <i>%%%-----------------------------------------------------------------</i>
<a name="45"/>   45: <i>%%% -spec init_tc(Mod,Func,Args) -&gt; {ok,NewArgs} | {error,Reason} |</i>
<a name="46"/>   46: <i>%%%         {skip,Reason} | {auto_skip,Reason}</i>
<a name="47"/>   47: <i>%%%      Mod = atom()</i>
<a name="48"/>   48: <i>%%%      Func = atom()</i>
<a name="49"/>   49: <i>%%%      Args = list()</i>
<a name="50"/>   50: <i>%%%      NewArgs = list()</i>
<a name="51"/>   51: <i>%%%      Reason = term()</i>
<a name="52"/>   52: <i>%%%</i>
<a name="53"/>   53: <i>%%% Test server framework callback, called by the test_server</i>
<a name="54"/>   54: <i>%%% when a new test case is started.</i>
<a name="init_tc-3"/><a name="55"/>   55: <b>init_tc</b>(_,{end_per_testcase_not_run,_},[Config]) -&gt;
<a name="56"/>   56:     %% Testcase is completed (skipped or failed), but end_per_testcase
<a name="57"/>   57:     %% is not run - don't call pre-hook.
<a name="58"/>   58:     {ok,[Config]};
<a name="59"/>   59: <b>init_tc</b>(Mod,EPTC={end_per_testcase,_},[Config]) -&gt;
<a name="60"/>   60:     %% in case Mod == ct_framework, lookup the suite name
<a name="61"/>   61:     Suite = get_suite_name(Mod, Config),
<a name="62"/>   62:     case ct_hooks:init_tc(Suite,EPTC,Config) of
<a name="63"/>   63: 	NewConfig when is_list(NewConfig) -&gt;
<a name="64"/>   64: 	    {ok,[NewConfig]};
<a name="65"/>   65: 	Other-&gt;
<a name="66"/>   66: 	    Other
<a name="67"/>   67:     end;
<a name="68"/>   68: 
<a name="69"/>   69: <b>init_tc</b>(Mod,Func0,Args) -&gt;
<a name="70"/>   70:     %% in case Mod == ct_framework, lookup the suite name
<a name="71"/>   71:     Suite = get_suite_name(Mod, Args),
<a name="72"/>   72:     {Func,HookFunc} = case Func0 of
<a name="73"/>   73: 			  {init_per_testcase,F} -&gt; {F,Func0};
<a name="74"/>   74: 			  _                     -&gt; {Func0,Func0}
<a name="75"/>   75: 		      end,
<a name="76"/>   76: 
<a name="77"/>   77:     %% check if previous testcase was interpreted and has left
<a name="78"/>   78:     %% a &quot;dead&quot; trace window behind - if so, kill it
<a name="79"/>   79:     case ct_util:get_testdata(interpret) of
<a name="80"/>   80: 	{What,kill,{TCPid,AttPid}} -&gt;
<a name="81"/>   81: 	    ct_util:kill_attached(TCPid,AttPid),
<a name="82"/>   82: 	    ct_util:set_testdata({interpret,{What,kill,{undefined,undefined}}});
<a name="83"/>   83: 	_ -&gt;
<a name="84"/>   84: 	    ok
<a name="85"/>   85:     end,
<a name="86"/>   86: 
<a name="init_tc-last_expr"/><a name="87"/>   87:     case Func=/=end_per_suite
<a name="88"/>   88: 	andalso Func=/=end_per_group
<a name="89"/>   89: 	andalso ct_util:get_testdata(skip_rest) of
<a name="90"/>   90: 	true -&gt;
<a name="91"/>   91:             initialize(false,Mod,Func,Args),
<a name="92"/>   92: 	    {auto_skip,&quot;Repeated test stopped by force_stop option&quot;};
<a name="93"/>   93: 	_ -&gt;
<a name="94"/>   94: 	    case ct_util:get_testdata(curr_tc) of
<a name="95"/>   95: 		{Suite,{suite0_failed,{require,Reason}}} -&gt;
<a name="96"/>   96:                     initialize(false,Mod,Func,Args),
<a name="97"/>   97: 		    {auto_skip,{require_failed_in_suite0,Reason}};
<a name="98"/>   98: 		{Suite,{suite0_failed,_}=Failure} -&gt;
<a name="99"/>   99:                     initialize(false,Mod,Func,Args),
<a name="100"/>  100: 		    {fail,Failure};
<a name="101"/>  101: 		_ -&gt;
<a name="102"/>  102: 		    ct_util:update_testdata(curr_tc,
<a name="103"/>  103: 					    fun(undefined) -&gt;
<a name="104"/>  104: 						    [{Suite,Func}];
<a name="105"/>  105: 					       (Running) -&gt;
<a name="106"/>  106: 						    [{Suite,Func}|Running]
<a name="107"/>  107: 					    end, [create]),
<a name="108"/>  108: 		    case ct_util:read_suite_data({seq,Suite,Func}) of
<a name="109"/>  109: 			undefined -&gt;
<a name="110"/>  110: 			    init_tc1(Mod,Suite,Func,HookFunc,Args);
<a name="111"/>  111: 			Seq when is_atom(Seq) -&gt;
<a name="112"/>  112: 			    case ct_util:read_suite_data({seq,Suite,Seq}) of
<a name="113"/>  113: 				[Func|TCs] -&gt; % this is the 1st case in Seq
<a name="114"/>  114: 				    %% make sure no cases in this seq are
<a name="115"/>  115: 				    %% marked as failed from an earlier execution
<a name="116"/>  116: 				    %% in the same suite
<a name="117"/>  117: 				    lists:foreach(
<a name="118"/>  118: 				      fun(TC) -&gt;
<a name="119"/>  119: 					      ct_util:save_suite_data(
<a name="120"/>  120: 						{seq,Suite,TC},
<a name="121"/>  121: 						Seq)
<a name="122"/>  122: 				      end, TCs);
<a name="123"/>  123: 				_ -&gt;
<a name="124"/>  124: 				    ok
<a name="125"/>  125: 			    end,
<a name="126"/>  126: 			    init_tc1(Mod,Suite,Func,HookFunc,Args);
<a name="127"/>  127: 			{failed,Seq,BadFunc} -&gt;
<a name="128"/>  128:                             initialize(false,Mod,Func,Args),
<a name="129"/>  129:                             {auto_skip,{sequence_failed,Seq,BadFunc}}
<a name="130"/>  130: 		    end
<a name="131"/>  131: 	    end
<a name="132"/>  132:     end.
<a name="133"/>  133: 
<a name="init_tc1-5"/><a name="134"/>  134: <b>init_tc1</b>(?MODULE,_,error_in_suite,_,[Config0]) when is_list(Config0) -&gt;
<a name="135"/>  135:     initialize(false,?MODULE,error_in_suite),
<a name="136"/>  136:     _ = ct_suite_init(?MODULE,error_in_suite,[],Config0),
<a name="137"/>  137:     case ?val(error,Config0) of
<a name="138"/>  138: 	undefined -&gt;
<a name="139"/>  139: 	    {fail,&quot;unknown_error_in_suite&quot;};
<a name="140"/>  140: 	Reason -&gt;
<a name="141"/>  141: 	    {fail,Reason}
<a name="142"/>  142:     end;
<a name="143"/>  143: 
<a name="144"/>  144: <b>init_tc1</b>(Mod,Suite,Func,HookFunc,[Config0]) when is_list(Config0) -&gt;
<a name="145"/>  145:     Config1 = 
<a name="146"/>  146: 	case ct_util:read_suite_data(last_saved_config) of
<a name="147"/>  147: 	    {{Suite,LastFunc},SavedConfig} -&gt;	% last testcase
<a name="148"/>  148: 		[{saved_config,{LastFunc,SavedConfig}} | 
<a name="149"/>  149: 		 lists:keydelete(saved_config,1,Config0)];
<a name="150"/>  150: 	    {{LastSuite,InitOrEnd},
<a name="151"/>  151: 	     SavedConfig} when InitOrEnd == init_per_suite ;
<a name="152"/>  152: 			       InitOrEnd == end_per_suite -&gt;
<a name="153"/>  153: 		%% last suite
<a name="154"/>  154: 		[{saved_config,{LastSuite,SavedConfig}} | 
<a name="155"/>  155: 		 lists:keydelete(saved_config,1,Config0)];
<a name="156"/>  156: 	    undefined -&gt;
<a name="157"/>  157: 		lists:keydelete(saved_config,1,Config0)
<a name="158"/>  158: 	end,
<a name="159"/>  159:     ct_util:delete_suite_data(last_saved_config),
<a name="160"/>  160:     Config = lists:keydelete(watchdog,1,Config1),
<a name="161"/>  161: 
<a name="162"/>  162:     if Func == init_per_suite -&gt;
<a name="163"/>  163: 	    %% delete all default values used in previous suite
<a name="164"/>  164: 	    ct_config:delete_default_config(suite),
<a name="165"/>  165: 	    %% release all name -&gt; key bindings (once per suite)
<a name="166"/>  166: 	    ct_config:release_allocated();
<a name="167"/>  167:        Func /= init_per_suite -&gt;
<a name="168"/>  168: 	    ok
<a name="169"/>  169:     end,
<a name="170"/>  170: 
<a name="171"/>  171:     GroupPath = ?val(tc_group_path, Config, []),
<a name="172"/>  172:     AllGroups =	[?val(tc_group_properties, Config, []) | GroupPath],
<a name="173"/>  173: 
<a name="174"/>  174:     %% clear all config data default values set by previous
<a name="175"/>  175:     %% testcase info function (these should only survive the
<a name="176"/>  176:     %% testcase, not the whole suite)
<a name="177"/>  177:     FuncSpec = group_or_func(Func,Config0),
<a name="178"/>  178:     HookFunc1 =
<a name="179"/>  179: 	if is_tuple(FuncSpec) -&gt;		% group
<a name="180"/>  180: 	    FuncSpec;
<a name="181"/>  181: 	   true -&gt;
<a name="182"/>  182: 		ct_config:delete_default_config(testcase),
<a name="183"/>  183: 		HookFunc
<a name="184"/>  184: 	end,
<a name="185"/>  185:     case add_defaults(Mod,Func,AllGroups) of
<a name="186"/>  186: 	Error = {suite0_failed,_} -&gt;
<a name="187"/>  187: 	    initialize(false,Mod,FuncSpec),
<a name="188"/>  188: 	    ct_util:set_testdata({curr_tc,{Suite,Error}}),
<a name="189"/>  189: 	    {error,Error};
<a name="190"/>  190: 	Error = {group0_failed,_} -&gt;
<a name="191"/>  191: 	    initialize(false,Mod,FuncSpec),
<a name="192"/>  192: 	    {auto_skip,Error};
<a name="193"/>  193: 	Error = {testcase0_failed,_} -&gt;
<a name="194"/>  194: 	    initialize(false,Mod,FuncSpec),
<a name="195"/>  195: 	    {auto_skip,Error};
<a name="196"/>  196: 	{SuiteInfo,MergeResult} -&gt;
<a name="197"/>  197: 	    case MergeResult of
<a name="198"/>  198: 		{error,Reason} -&gt;
<a name="199"/>  199: 		    initialize(false,Mod,FuncSpec),
<a name="200"/>  200: 		    {fail,Reason};
<a name="201"/>  201: 		_ -&gt;
<a name="202"/>  202: 		    init_tc2(Mod,Suite,Func,HookFunc1,
<a name="203"/>  203: 			     SuiteInfo,MergeResult,Config)
<a name="204"/>  204: 	    end
<a name="205"/>  205:     end;
<a name="206"/>  206: 
<a name="207"/>  207: <b>init_tc1</b>(_Mod,_Suite,_Func,_HookFunc,Args) -&gt;
<a name="init_tc1-last_expr"/><a name="208"/>  208:     {ok,Args}.
<a name="209"/>  209: 
<a name="init_tc2-7"/><a name="210"/>  210: <b>init_tc2</b>(Mod,Suite,Func,HookFunc,SuiteInfo,MergeResult,Config) -&gt;
<a name="211"/>  211:     %% timetrap must be handled before require
<a name="212"/>  212:     MergedInfo = timetrap_first(MergeResult, [], []),
<a name="213"/>  213:     %% tell logger to use specified style sheet
<a name="214"/>  214:     _ = case lists:keysearch(stylesheet,1,MergeResult++Config) of
<a name="215"/>  215: 	{value,{stylesheet,SSFile}} -&gt;
<a name="216"/>  216: 	    ct_logs:set_stylesheet(Func,add_data_dir(SSFile,Config));
<a name="217"/>  217: 	_ -&gt;
<a name="218"/>  218: 	    case ct_util:get_testdata(stylesheet) of
<a name="219"/>  219: 		undefined -&gt;
<a name="220"/>  220: 		    ct_logs:clear_stylesheet(Func);
<a name="221"/>  221: 		SSFile -&gt;
<a name="222"/>  222: 		    ct_logs:set_stylesheet(Func,SSFile)
<a name="223"/>  223: 	    end
<a name="224"/>  224:     end,
<a name="225"/>  225:     %% suppress output for connections (Conns is a 
<a name="226"/>  226:     %% list of {Type,Bool} tuples, e.g. {telnet,true}),		
<a name="227"/>  227:     case ct_util:get_overridden_silenced_connections() of
<a name="228"/>  228: 	undefined -&gt;
<a name="229"/>  229: 	    case lists:keysearch(silent_connections,1,MergeResult++Config) of
<a name="230"/>  230: 		{value,{silent_connections,Conns}} -&gt;
<a name="231"/>  231: 		    ct_util:silence_connections(Conns);
<a name="232"/>  232: 		_ -&gt;
<a name="233"/>  233: 		    ok
<a name="234"/>  234: 	    end;
<a name="235"/>  235: 	Conns -&gt;
<a name="236"/>  236: 	    ct_util:silence_connections(Conns)
<a name="237"/>  237:     end,
<a name="238"/>  238:     FuncSpec = group_or_func(Func,Config),
<a name="239"/>  239:     initialize((Func==init_per_suite),Mod,FuncSpec),
<a name="240"/>  240: 
<a name="init_tc2-last_expr"/><a name="241"/>  241: <b>    case catch configure</b>(MergedInfo,MergedInfo,SuiteInfo,
<a name="242"/>  242: 			 FuncSpec,[],Config) of
<a name="243"/>  243: 	{suite0_failed,Reason} -&gt;
<a name="244"/>  244: 	    ct_util:set_testdata({curr_tc,{Mod,{suite0_failed,
<a name="245"/>  245: 						{require,Reason}}}}),
<a name="246"/>  246: 	    {auto_skip,{require_failed_in_suite0,Reason}};
<a name="247"/>  247: 	{error,Reason} -&gt;
<a name="248"/>  248: 	    {auto_skip,{require_failed,Reason}};
<a name="249"/>  249: 	{'EXIT',Reason} -&gt;
<a name="250"/>  250: 	    {fail,Reason};
<a name="251"/>  251: 	{ok,PostInitHook,Config1} -&gt;
<a name="252"/>  252: 	    case get('$test_server_framework_test') of
<a name="253"/>  253: 		undefined -&gt;
<a name="254"/>  254: 		    ct_suite_init(Suite,HookFunc,PostInitHook,Config1);
<a name="255"/>  255: 		Fun -&gt;
<a name="256"/>  256: 		    PostInitHookResult = do_post_init_hook(PostInitHook,
<a name="257"/>  257: 							   Config1),
<a name="258"/>  258: 		    case Fun(init_tc, [PostInitHookResult ++ Config1]) of
<a name="259"/>  259: 			NewConfig when is_list(NewConfig) -&gt;
<a name="260"/>  260: 			    {ok,NewConfig};
<a name="261"/>  261: 			Else -&gt;
<a name="262"/>  262: 			    Else
<a name="263"/>  263: 		    end
<a name="264"/>  264: 	    end
<a name="265"/>  265:     end.
<a name="266"/>  266: 
<a name="initialize-4"/><a name="267"/>  267: <b>initialize</b>(RefreshLogs,Mod,Func,[Config]) when is_list(Config) -&gt;
<a name="268"/>  268:     initialize(RefreshLogs,Mod,group_or_func(Func,Config));
<a name="269"/>  269: <b>initialize</b>(RefreshLogs,Mod,Func,_) -&gt;
<a name="initialize-last_expr"/><a name="270"/>  270: <b>    initialize</b>(RefreshLogs,Mod,Func).
<a name="271"/>  271: 
<a name="initialize-3"/><a name="272"/>  272: <b>initialize</b>(RefreshLogs,Mod,FuncSpec) -&gt;
<a name="273"/>  273:     ct_logs:init_tc(RefreshLogs),
<a name="initialize-last_expr"/><a name="274"/>  274: <b>    ct_event:notify</b>(#event{name=tc_start,
<a name="275"/>  275: 			   node=node(),
<a name="276"/>  276: 			   data={Mod,FuncSpec}}).
<a name="277"/>  277: 
<a name="278"/>  278: 
<a name="ct_suite_init-4"/><a name="279"/>  279: <b>ct_suite_init</b>(Suite,HookFunc,PostInitHook,Config) when is_list(Config) -&gt;
<a name="ct_suite_init-last_expr"/><a name="280"/>  280: <b>    case ct_hooks:init_tc</b>(Suite,HookFunc,Config) of
<a name="281"/>  281: 	NewConfig when is_list(NewConfig) -&gt;
<a name="282"/>  282: 	    PostInitHookResult = do_post_init_hook(PostInitHook,NewConfig),
<a name="283"/>  283: 	    {ok, [PostInitHookResult ++ NewConfig]};
<a name="284"/>  284: 	Else -&gt;
<a name="285"/>  285: 	    Else
<a name="286"/>  286:     end.
<a name="287"/>  287: 
<a name="do_post_init_hook-2"/><a name="288"/>  288: <b>do_post_init_hook</b>(PostInitHook,Config) -&gt;
<a name="do_post_init_hook-last_expr"/><a name="289"/>  289: <b>    lists:flatmap</b>(fun({Tag,Fun}) -&gt;
<a name="290"/>  290: 			  case lists:keysearch(Tag,1,Config) of
<a name="291"/>  291: 			      {value,_} -&gt;
<a name="292"/>  292: 				  [];
<a name="293"/>  293: 			      false -&gt; 
<a name="294"/>  294: 				  case Fun() of
<a name="295"/>  295: 				      {error,_} -&gt; [];
<a name="296"/>  296: 				      Result    -&gt; [{Tag,Result}]
<a name="297"/>  297: 				  end
<a name="298"/>  298: 			  end
<a name="299"/>  299: 		  end, PostInitHook).
<a name="300"/>  300: 
<a name="add_defaults-3"/><a name="301"/>  301: <b>add_defaults</b>(Mod,Func, GroupPath) -&gt;
<a name="302"/>  302:     Suite = get_suite_name(Mod, GroupPath),
<a name="add_defaults-last_expr"/><a name="303"/>  303: <b>    case </b>(catch Suite:suite()) of
<a name="304"/>  304: 	{'EXIT',{undef,_}} -&gt;
<a name="305"/>  305: 	    SuiteInfo = merge_with_suite_defaults(Suite,[]),
<a name="306"/>  306: 	    SuiteInfoNoCTH = [I || I &lt;- SuiteInfo, element(1,I) =/= ct_hooks],
<a name="307"/>  307: 	    case add_defaults1(Mod,Func, GroupPath, SuiteInfoNoCTH) of
<a name="308"/>  308: 		Error = {group0_failed,_} -&gt; Error;
<a name="309"/>  309: 		Error = {testcase0_failed,_} -&gt; Error;
<a name="310"/>  310: 		Error = {error,_} -&gt; {SuiteInfo,Error};
<a name="311"/>  311: 		MergedInfo -&gt; {SuiteInfo,MergedInfo}
<a name="312"/>  312: 	    end;
<a name="313"/>  313: 	{'EXIT',Reason} -&gt;
<a name="314"/>  314: 	    ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="315"/>  315: 				   &quot;~w:suite/0 failed: ~tp~n&quot;,
<a name="316"/>  316: 				   [Suite,Reason]),
<a name="317"/>  317: 	    io:format(&quot;~ts&quot;, [ErrStr]),
<a name="318"/>  318: 	    io:format(?def_gl, &quot;~ts&quot;, [ErrStr]),
<a name="319"/>  319: 	    {suite0_failed,{exited,Reason}};
<a name="320"/>  320: 	SuiteInfo when is_list(SuiteInfo) -&gt;
<a name="321"/>  321: 	    case lists:all(fun(E) when is_tuple(E) -&gt; true;
<a name="322"/>  322: 			      (_) -&gt; false
<a name="323"/>  323: 			   end, SuiteInfo) of
<a name="324"/>  324: 		true -&gt;
<a name="325"/>  325: 		    SuiteInfo1 = merge_with_suite_defaults(Suite, SuiteInfo),
<a name="326"/>  326: 		    SuiteInfoNoCTH = [I || I &lt;- SuiteInfo1,
<a name="327"/>  327: 					   element(1,I) =/= ct_hooks],
<a name="328"/>  328: 		    case add_defaults1(Mod,Func, GroupPath,
<a name="329"/>  329: 				       SuiteInfoNoCTH) of
<a name="330"/>  330: 			Error = {group0_failed,_} -&gt; Error;
<a name="331"/>  331: 			Error = {testcase0_failed,_} -&gt; Error;
<a name="332"/>  332: 			Error = {error,_} -&gt; {SuiteInfo1,Error};
<a name="333"/>  333: 			MergedInfo -&gt; {SuiteInfo1,MergedInfo}
<a name="334"/>  334: 		    end;
<a name="335"/>  335: 		false -&gt;
<a name="336"/>  336: 		    ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="337"/>  337: 					   &quot;Invalid return value from &quot;
<a name="338"/>  338: 					   &quot;~w:suite/0: ~tp~n&quot;,
<a name="339"/>  339: 					   [Suite,SuiteInfo]),
<a name="340"/>  340: 		    io:format(&quot;~ts&quot;, [ErrStr]),
<a name="341"/>  341: 		    io:format(?def_gl, &quot;~ts&quot;, [ErrStr]),
<a name="342"/>  342: 		    {suite0_failed,bad_return_value}
<a name="343"/>  343: 	    end;
<a name="344"/>  344: 	SuiteInfo -&gt;
<a name="345"/>  345: 	    ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="346"/>  346: 				   &quot;Invalid return value from &quot;
<a name="347"/>  347: 				   &quot;~w:suite/0: ~tp~n&quot;, [Suite,SuiteInfo]),
<a name="348"/>  348: 	    io:format(&quot;~ts&quot;, [ErrStr]),
<a name="349"/>  349: 	    io:format(?def_gl, &quot;~ts&quot;, [ErrStr]),
<a name="350"/>  350: 	    {suite0_failed,bad_return_value}
<a name="351"/>  351:     end.
<a name="352"/>  352: 
<a name="add_defaults1-4"/><a name="353"/>  353: <b>add_defaults1</b>(Mod,Func, GroupPath, SuiteInfo) -&gt;
<a name="354"/>  354:     Suite = get_suite_name(Mod, GroupPath),
<a name="355"/>  355:     %% GroupPathInfo (for subgroup on level X) =
<a name="356"/>  356:     %%     [LevelXGroupInfo, LevelX-1GroupInfo, ..., TopLevelGroupInfo]
<a name="357"/>  357:     GroupPathInfo =  
<a name="358"/>  358: 	lists:map(fun(GroupProps) -&gt;
<a name="359"/>  359: 			  case ?val(name, GroupProps) of
<a name="360"/>  360: 			      undefined -&gt;
<a name="361"/>  361: 				  [];
<a name="362"/>  362: 			      Name -&gt;
<a name="363"/>  363: 				  case catch Suite:group(Name) of
<a name="364"/>  364: 				      GrInfo when is_list(GrInfo) -&gt; GrInfo;
<a name="365"/>  365: 				      {'EXIT',{undef,_}} -&gt; [];
<a name="366"/>  366: 				      BadGr0 -&gt; {error,BadGr0,Name}
<a name="367"/>  367: 				  end
<a name="368"/>  368: 			  end
<a name="369"/>  369: 		  end, GroupPath),
<a name="add_defaults1-last_expr"/><a name="370"/>  370: <b>    case lists:keysearch</b>(error, 1, GroupPathInfo) of
<a name="371"/>  371: 	{value,{error,BadGr0Val,GrName}} -&gt;
<a name="372"/>  372: 	    Gr0ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="373"/>  373: 				      &quot;Invalid return value from &quot;
<a name="374"/>  374: 				      &quot;~w:group(~tw): ~tp~n&quot;,
<a name="375"/>  375: 				      [Mod,GrName,BadGr0Val]),
<a name="376"/>  376: 	    io:format(&quot;~ts&quot;, [Gr0ErrStr]),
<a name="377"/>  377: 	    io:format(?def_gl, &quot;~ts&quot;, [Gr0ErrStr]),
<a name="378"/>  378: 	    {group0_failed,bad_return_value};
<a name="379"/>  379: 	_ -&gt;
<a name="380"/>  380: 	    Args = if Func == init_per_group ; Func == end_per_group -&gt;
<a name="381"/>  381: 			   [?val(name, hd(GroupPath))];
<a name="382"/>  382: 		      true -&gt;
<a name="383"/>  383: 			   []
<a name="384"/>  384: 		   end,
<a name="385"/>  385: 	    TestCaseInfo =
<a name="386"/>  386: 		case catch apply(Mod,Func,Args) of
<a name="387"/>  387: 		    TCInfo when is_list(TCInfo) -&gt; TCInfo;
<a name="388"/>  388: 		    {'EXIT',{undef,_}} -&gt; [];
<a name="389"/>  389: 		    BadTC0 -&gt; {error,BadTC0}
<a name="390"/>  390: 		end,
<a name="391"/>  391: 	    
<a name="392"/>  392: 	    case TestCaseInfo of
<a name="393"/>  393: 		{error,BadTC0Val} -&gt;
<a name="394"/>  394: 		    TC0ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="395"/>  395: 					      &quot;Invalid return value from &quot;
<a name="396"/>  396: 					      &quot;~w:~tw/0: ~tp~n&quot;,
<a name="397"/>  397: 					      [Mod,Func,BadTC0Val]),
<a name="398"/>  398: 		    io:format(&quot;~ts&quot;, [TC0ErrStr]),
<a name="399"/>  399: 		    io:format(?def_gl, &quot;~ts&quot;, [TC0ErrStr]),
<a name="400"/>  400: 		    {testcase0_failed,bad_return_value};
<a name="401"/>  401: 		_ -&gt;
<a name="402"/>  402: 		    %% let test case info (also for all config funcs) override
<a name="403"/>  403: 		    %% group info, and lower level group info override higher
<a name="404"/>  404: 		    %% level info
<a name="405"/>  405: 		    TCAndGroupInfo =
<a name="406"/>  406: 			[TestCaseInfo | remove_info_in_prev(TestCaseInfo,
<a name="407"/>  407: 							    GroupPathInfo)],
<a name="408"/>  408: 		    %% find and save require terms found in suite info
<a name="409"/>  409: 		    SuiteReqs = 
<a name="410"/>  410: 			[SDDef || SDDef &lt;- SuiteInfo,
<a name="411"/>  411: 				  ((require == element(1,SDDef))
<a name="412"/>  412: 				   or (default_config == element(1,SDDef)))],
<a name="413"/>  413: 		    case check_for_clashes(TestCaseInfo, GroupPathInfo,
<a name="414"/>  414: 					   SuiteReqs) of
<a name="415"/>  415: 			[] -&gt;
<a name="416"/>  416: 			    add_defaults2(Mod,Func, TCAndGroupInfo,
<a name="417"/>  417: 					  SuiteInfo,SuiteReqs);
<a name="418"/>  418: 			Clashes -&gt;
<a name="419"/>  419: 			    {error,{config_name_already_in_use,Clashes}}
<a name="420"/>  420: 		    end
<a name="421"/>  421: 	    end
<a name="422"/>  422:     end.
<a name="423"/>  423: 
<a name="get_suite_name-2"/><a name="424"/>  424: <b>get_suite_name</b>(?MODULE, [Cfg|_]) when is_list(Cfg), Cfg /= [] -&gt;
<a name="425"/>  425:     get_suite_name(?MODULE, Cfg);
<a name="426"/>  426: 
<a name="427"/>  427: <b>get_suite_name</b>(?MODULE, Cfg) when is_list(Cfg), Cfg /= [] -&gt;
<a name="428"/>  428:     case ?val(tc_group_properties, Cfg) of
<a name="429"/>  429: 	undefined -&gt;
<a name="430"/>  430: 	    case ?val(suite, Cfg) of
<a name="431"/>  431: 		undefined -&gt; ?MODULE;
<a name="432"/>  432: 		Suite -&gt; Suite
<a name="433"/>  433: 	    end;
<a name="434"/>  434: 	GrProps -&gt;
<a name="435"/>  435: 	    case ?val(suite, GrProps) of
<a name="436"/>  436: 		undefined -&gt; ?MODULE;
<a name="437"/>  437: 		Suite -&gt; Suite
<a name="438"/>  438: 	    end
<a name="439"/>  439:     end;
<a name="440"/>  440: <b>get_suite_name</b>(Mod, _) -&gt;
<a name="get_suite_name-last_expr"/><a name="441"/>  441:     Mod.
<a name="442"/>  442: 
<a name="443"/>  443: <i>%% Check that alias names are not already in use</i>
<a name="check_for_clashes-3"/><a name="444"/>  444: <b>check_for_clashes</b>(TCInfo, [CurrGrInfo|Path], SuiteInfo) -&gt;
<a name="445"/>  445:     ReqNames = fun(Info) -&gt; [element(2,R) || R &lt;- Info,
<a name="446"/>  446: 					     size(R) == 3,
<a name="447"/>  447: 					     require == element(1,R)]
<a name="448"/>  448: 	       end,
<a name="449"/>  449:     ExistingNames = lists:flatten([ReqNames(L)  || L &lt;- [SuiteInfo|Path]]),
<a name="450"/>  450:     CurrGrReqNs = ReqNames(CurrGrInfo),
<a name="451"/>  451:     GrClashes = [Name || Name &lt;- CurrGrReqNs,
<a name="452"/>  452: 			 true == lists:member(Name, ExistingNames)],
<a name="453"/>  453:     AllReqNs = CurrGrReqNs ++ ExistingNames,
<a name="454"/>  454:     TCClashes = [Name || Name &lt;- ReqNames(TCInfo),
<a name="455"/>  455: 			 true == lists:member(Name, AllReqNs)],
<a name="check_for_clashes-last_expr"/><a name="456"/>  456:     TCClashes ++ GrClashes.
<a name="457"/>  457: 
<a name="458"/>  458: <i>%% Delete the info terms in Terms from all following info lists</i>
<a name="remove_info_in_prev-2"/><a name="459"/>  459: <b>remove_info_in_prev</b>(Terms, [[] | Rest]) -&gt;
<a name="460"/>  460:     [[] | remove_info_in_prev(Terms, Rest)];
<a name="461"/>  461: <b>remove_info_in_prev</b>(Terms, [Info | Rest]) -&gt;
<a name="462"/>  462:     UniqueInInfo = [U || U &lt;- Info,
<a name="463"/>  463: 			  ((timetrap == element(1,U)) and
<a name="464"/>  464: 			   (not lists:keymember(timetrap,1,Terms))) or 
<a name="465"/>  465: 			  ((require == element(1,U)) and
<a name="466"/>  466: 			   (not lists:member(U,Terms))) or
<a name="467"/>  467: 			  ((default_config == element(1,U)) and
<a name="468"/>  468:                            (not keysmember([default_config,1,
<a name="469"/>  469: 					    element(2,U),2], Terms)))],
<a name="470"/>  470:     OtherTermsInInfo = [T || T &lt;- Info,
<a name="471"/>  471: 			     timetrap /= element(1,T),
<a name="472"/>  472: 			     require /= element(1,T),
<a name="473"/>  473: 			     default_config /= element(1,T),
<a name="474"/>  474: 			     false == lists:keymember(element(1,T),1,
<a name="475"/>  475: 						      Terms)],
<a name="476"/>  476:     KeptInfo = UniqueInInfo ++ OtherTermsInInfo,
<a name="477"/>  477:     [KeptInfo | remove_info_in_prev(Terms ++ KeptInfo, Rest)];
<a name="478"/>  478: <b>remove_info_in_prev</b>(_, []) -&gt;
<a name="remove_info_in_prev-last_expr"/><a name="479"/>  479:     [].
<a name="480"/>  480: 
<a name="keysmember-2"/><a name="481"/>  481: <b>keysmember</b>([Key,Pos|Next], List) -&gt;
<a name="482"/>  482:     case [Elem || Elem &lt;- List, Key == element(Pos,Elem)] of
<a name="483"/>  483: 	[]    -&gt; false;
<a name="484"/>  484: 	Found -&gt; keysmember(Next, Found)
<a name="485"/>  485:     end;
<a name="keysmember-last_expr"/><a name="486"/>  486: <b>keysmember</b>([], _) -&gt; true.
<a name="487"/>  487: 
<a name="488"/>  488: 
<a name="add_defaults2-5"/><a name="489"/>  489: <b>add_defaults2</b>(_Mod,init_per_suite, IPSInfo, SuiteInfo,SuiteReqs) -&gt;
<a name="490"/>  490:     Info = lists:flatten([IPSInfo, SuiteReqs]),
<a name="491"/>  491:     lists:flatten([Info,remove_info_in_prev(Info, [SuiteInfo])]);
<a name="492"/>  492: 
<a name="493"/>  493: <b>add_defaults2</b>(_Mod,init_per_group, IPGAndGroupInfo, SuiteInfo,SuiteReqs) -&gt;
<a name="494"/>  494:     SuiteInfo1 =
<a name="495"/>  495: 	remove_info_in_prev(lists:flatten([IPGAndGroupInfo,
<a name="496"/>  496: 					   SuiteReqs]), [SuiteInfo]),
<a name="497"/>  497:     %% don't require terms in prev groups (already processed)
<a name="498"/>  498:     case IPGAndGroupInfo of
<a name="499"/>  499: 	[IPGInfo] -&gt;
<a name="500"/>  500: 	    lists:flatten([IPGInfo,SuiteInfo1]);
<a name="501"/>  501: 	[IPGInfo | [CurrGroupInfo | PrevGroupInfo]] -&gt;
<a name="502"/>  502: 	    PrevGroupInfo1 = delete_require_terms(PrevGroupInfo),
<a name="503"/>  503: 	    lists:flatten([IPGInfo,CurrGroupInfo,PrevGroupInfo1,
<a name="504"/>  504: 			   SuiteInfo1])
<a name="505"/>  505:     end;
<a name="506"/>  506: 
<a name="507"/>  507: <b>add_defaults2</b>(_Mod,_Func, TCAndGroupInfo, SuiteInfo,SuiteReqs) -&gt;
<a name="508"/>  508:     %% Include require elements from test case info and current group,
<a name="509"/>  509:     %% but not from previous groups or suite/0 (since we've already required
<a name="510"/>  510:     %% those vars). Let test case info elements override group and suite
<a name="511"/>  511:     %% info elements.
<a name="512"/>  512:     SuiteInfo1 = remove_info_in_prev(lists:flatten([TCAndGroupInfo,
<a name="513"/>  513: 						    SuiteReqs]), [SuiteInfo]),
<a name="514"/>  514:     %% don't require terms in prev groups (already processed)
<a name="add_defaults2-last_expr"/><a name="515"/>  515:     case TCAndGroupInfo of
<a name="516"/>  516: 	[TCInfo] -&gt;
<a name="517"/>  517: 	    lists:flatten([TCInfo,SuiteInfo1]);
<a name="518"/>  518: 	[TCInfo | [CurrGroupInfo | PrevGroupInfo]] -&gt;
<a name="519"/>  519: 	    PrevGroupInfo1 = delete_require_terms(PrevGroupInfo),
<a name="520"/>  520: 	    lists:flatten([TCInfo,CurrGroupInfo,PrevGroupInfo1,
<a name="521"/>  521: 			   SuiteInfo1])
<a name="522"/>  522:     end.
<a name="523"/>  523: 
<a name="delete_require_terms-1"/><a name="524"/>  524: <b>delete_require_terms</b>([Info | Prev]) -&gt;
<a name="525"/>  525:     Info1 = [T || T &lt;- Info, 
<a name="526"/>  526: 		  require /= element(1,T),
<a name="527"/>  527: 		  default_config /= element(1,T)],
<a name="528"/>  528:     [Info1 | delete_require_terms(Prev)];
<a name="529"/>  529: <b>delete_require_terms</b>([]) -&gt;
<a name="delete_require_terms-last_expr"/><a name="530"/>  530:     [].
<a name="531"/>  531: 
<a name="merge_with_suite_defaults-2"/><a name="532"/>  532: <b>merge_with_suite_defaults</b>(Mod,SuiteInfo) -&gt;
<a name="merge_with_suite_defaults-last_expr"/><a name="533"/>  533: <b>    case lists:keysearch</b>(suite_defaults,1,Mod:module_info(attributes)) of
<a name="534"/>  534: 	{value,{suite_defaults,Defaults}} -&gt;
<a name="535"/>  535: 	    SDReqs =
<a name="536"/>  536: 		[SDDef || SDDef &lt;- Defaults,
<a name="537"/>  537: 			  require == element(1,SDDef),
<a name="538"/>  538: 			  false == lists:keymember(element(2,SDDef),2,
<a name="539"/>  539: 						   SuiteInfo)],
<a name="540"/>  540: 	    SuiteInfo ++ SDReqs ++
<a name="541"/>  541: 		[SDDef || SDDef &lt;- Defaults,
<a name="542"/>  542: 			  require /= element(1,SDDef),
<a name="543"/>  543: 			  false == lists:keymember(element(1,SDDef),1,
<a name="544"/>  544: 						   SuiteInfo)];		    
<a name="545"/>  545: 	false -&gt;
<a name="546"/>  546: 	    SuiteInfo
<a name="547"/>  547:     end.
<a name="548"/>  548: 
<a name="timetrap_first-3"/><a name="549"/>  549: <b>timetrap_first</b>([Trap = {timetrap,_} | Rest],Info,Found) -&gt;
<a name="550"/>  550:     timetrap_first(Rest,Info,[Trap | Found]);
<a name="551"/>  551: <b>timetrap_first</b>([Other | Rest],Info,Found) -&gt;
<a name="552"/>  552:     timetrap_first(Rest,[Other | Info],Found);
<a name="553"/>  553: <b>timetrap_first</b>([],Info,[]) -&gt;
<a name="554"/>  554:     [{timetrap,{minutes,30}} | ?rev(Info)];
<a name="555"/>  555: <b>timetrap_first</b>([],Info,Found) -&gt;
<a name="timetrap_first-last_expr"/><a name="556"/>  556: <b>    ?rev</b>(Found) ++ ?rev(Info).
<a name="557"/>  557: 
<a name="configure-6"/><a name="558"/>  558: <b>configure</b>([{require,Required}|Rest],
<a name="559"/>  559: 	  Info,SuiteInfo,Scope,PostInitHook,Config) -&gt;
<a name="560"/>  560:     case ct:require(Required) of
<a name="561"/>  561: 	ok -&gt;
<a name="562"/>  562: 	    configure(Rest,Info,SuiteInfo,Scope,PostInitHook,Config);
<a name="563"/>  563: 	Error = {error,Reason} -&gt;
<a name="564"/>  564: 	    case required_default('_UNDEF',Required,Info,
<a name="565"/>  565: 				  SuiteInfo,Scope) of
<a name="566"/>  566: 		ok -&gt;
<a name="567"/>  567: 		    configure(Rest,Info,SuiteInfo,Scope,PostInitHook,Config);
<a name="568"/>  568: 		_ -&gt;
<a name="569"/>  569: 		    case lists:keymember(Required,2,SuiteInfo) of
<a name="570"/>  570: 			true -&gt;
<a name="571"/>  571: 			    {suite0_failed,Reason};
<a name="572"/>  572: 			false -&gt;
<a name="573"/>  573: 			    Error
<a name="574"/>  574: 		    end
<a name="575"/>  575: 	    end
<a name="576"/>  576:     end;
<a name="577"/>  577: <b>configure</b>([{require,Name,Required}|Rest],
<a name="578"/>  578: 	  Info,SuiteInfo,Scope,PostInitHook,Config) -&gt;
<a name="579"/>  579:     case ct:require(Name,Required) of
<a name="580"/>  580: 	ok -&gt;
<a name="581"/>  581: 	    configure(Rest,Info,SuiteInfo,Scope,PostInitHook,Config);
<a name="582"/>  582: 	Error = {error,Reason} -&gt;
<a name="583"/>  583: 	    case required_default(Name,Required,Info,SuiteInfo,Scope) of
<a name="584"/>  584: 		ok -&gt;
<a name="585"/>  585: 		    configure(Rest,Info,SuiteInfo,Scope,PostInitHook,Config);
<a name="586"/>  586: 		_ -&gt;
<a name="587"/>  587: 		    case lists:keymember(Name,2,SuiteInfo) of
<a name="588"/>  588: 			true -&gt; 
<a name="589"/>  589: 			    {suite0_failed,Reason};
<a name="590"/>  590: 			false -&gt;
<a name="591"/>  591: 			    Error
<a name="592"/>  592: 		    end
<a name="593"/>  593: 	    end
<a name="594"/>  594:     end;
<a name="595"/>  595: <b>configure</b>([{timetrap,off}|Rest],Info,SuiteInfo,Scope,PostInitHook,Config) -&gt;
<a name="596"/>  596:     configure(Rest,Info,SuiteInfo,Scope,PostInitHook,Config);
<a name="597"/>  597: <b>configure</b>([{timetrap,Time}|Rest],Info,SuiteInfo,Scope,PostInitHook,Config) -&gt;
<a name="598"/>  598:     PostInitHook1 = 
<a name="599"/>  599: 	[{watchdog,fun() -&gt; case test_server:get_timetrap_info() of
<a name="600"/>  600: 				undefined -&gt;
<a name="601"/>  601: 				    test_server:timetrap(Time);
<a name="602"/>  602: 				_ -&gt;
<a name="603"/>  603: 				    {error,already_set}
<a name="604"/>  604: 			    end
<a name="605"/>  605: 		   end} | PostInitHook],
<a name="606"/>  606:     configure(Rest,Info,SuiteInfo,Scope,PostInitHook1,Config);
<a name="607"/>  607: <b>configure</b>([{ct_hooks,Hook}|Rest],Info,SuiteInfo,Scope,PostInitHook,Config) -&gt;
<a name="608"/>  608:     configure(Rest,Info,SuiteInfo,Scope,PostInitHook,[{ct_hooks,Hook}|Config]);
<a name="609"/>  609: <b>configure</b>([_|Rest],Info,SuiteInfo,Scope,PostInitHook,Config) -&gt;
<a name="610"/>  610:     configure(Rest,Info,SuiteInfo,Scope,PostInitHook,Config);
<a name="611"/>  611: <b>configure</b>([],_,_,_,PostInitHook,Config) -&gt;
<a name="configure-last_expr"/><a name="612"/>  612:     {ok,PostInitHook,Config}.
<a name="613"/>  613: 
<a name="614"/>  614: <i>%% the require element in Info may come from suite/0 and</i>
<a name="615"/>  615: <i>%% should be scoped 'suite', or come from the group info</i>
<a name="616"/>  616: <i>%% function and be scoped 'group', or come from the testcase</i>
<a name="617"/>  617: <i>%% info function and then be scoped 'testcase'</i>
<a name="618"/>  618: 
<a name="required_default-5"/><a name="619"/>  619: <b>required_default</b>(Name,Key,Info,_,init_per_suite) -&gt;
<a name="620"/>  620:     try_set_default(Name,Key,Info,suite);
<a name="621"/>  621: <b>required_default</b>(Name,Key,Info,_,{init_per_group,GrName,_}) -&gt;
<a name="622"/>  622:     try_set_default(Name,Key,Info,{group,GrName});
<a name="623"/>  623: <b>required_default</b>(Name,Key,Info,_,_FuncSpec) -&gt;
<a name="required_default-last_expr"/><a name="624"/>  624: <b>    try_set_default</b>(Name,Key,Info,testcase).
<a name="625"/>  625: 
<a name="try_set_default-4"/><a name="626"/>  626: <b>try_set_default</b>(Name,Key,Info,Where) -&gt;
<a name="627"/>  627:     CfgElems = 
<a name="628"/>  628: 	case lists:keysearch(Name,1,Info) of
<a name="629"/>  629: 	    {value,{Name,Val}} -&gt;
<a name="630"/>  630: 		[Val];
<a name="631"/>  631: 	    false -&gt;
<a name="632"/>  632: 		case catch [{Key,element(3,Elem)} || Elem &lt;- Info,
<a name="633"/>  633: 						     element(1,Elem)==default_config,
<a name="634"/>  634: 						     element(2,Elem)==Key] of
<a name="635"/>  635: 		    {'EXIT',_} -&gt; [];
<a name="636"/>  636: 		    Result -&gt; Result
<a name="637"/>  637: 		end
<a name="638"/>  638: 	end,
<a name="try_set_default-last_expr"/><a name="639"/>  639:     case {Name,CfgElems} of
<a name="640"/>  640: 	{_,[]} -&gt; 
<a name="641"/>  641: 	    no_default;
<a name="642"/>  642: 	{'_UNDEF',_} -&gt;
<a name="643"/>  643: 	    _ = [ct_config:set_default_config([CfgVal],Where) || CfgVal &lt;- CfgElems],
<a name="644"/>  644: 	    ok;
<a name="645"/>  645: 	_ -&gt;
<a name="646"/>  646: 	    _ = [ct_config:set_default_config(Name,[CfgVal],Where) || CfgVal &lt;- CfgElems],
<a name="647"/>  647: 	    ok
<a name="648"/>  648:     end.
<a name="649"/>  649: 	    
<a name="650"/>  650: 
<a name="651"/>  651: <i>%%%-----------------------------------------------------------------</i>
<a name="652"/>  652: <i>%%% -spec end_tc(Mod,Func,Args) -&gt; {ok,NewArgs}| {error,Reason} |</i>
<a name="653"/>  653: <i>%%%         {skip,Reason} | {auto_skip,Reason}</i>
<a name="654"/>  654: <i>%%%      Mod = atom()</i>
<a name="655"/>  655: <i>%%%      Func = atom()</i>
<a name="656"/>  656: <i>%%%      Args = list()</i>
<a name="657"/>  657: <i>%%%      NewArgs = list()</i>
<a name="658"/>  658: <i>%%%      Reason = term()</i>
<a name="659"/>  659: <i>%%%</i>
<a name="660"/>  660: <i>%%% Test server framework callback, called by the test_server</i>
<a name="661"/>  661: <i>%%% when a test case is finished.</i>
<a name="end_tc-3"/><a name="662"/>  662: <b>end_tc</b>(Mod, Fun, Args) -&gt;
<a name="663"/>  663:     %% Have to keep end_tc/3 for backwards compatibility issues
<a name="end_tc-last_expr"/><a name="664"/>  664: <b>    end_tc</b>(Mod, Fun, Args, '$end_tc_dummy').
<a name="end_tc-4"/><a name="665"/>  665: <b>end_tc</b>(?MODULE,error_in_suite,{Result,[Args]},Return) -&gt;
<a name="666"/>  666:     %% this clause gets called if CT has encountered a suite that
<a name="667"/>  667:     %% can't be executed
<a name="668"/>  668:     FinalNotify =
<a name="669"/>  669: 	case ct_hooks:end_tc(?MODULE, error_in_suite, Args, Result, Return) of
<a name="670"/>  670: 	    '$ct_no_change' -&gt;
<a name="671"/>  671: 		Result;
<a name="672"/>  672: 	    HookResult -&gt;
<a name="673"/>  673: 		HookResult
<a name="674"/>  674: 	end,
<a name="675"/>  675:     Event = #event{name=tc_done,
<a name="676"/>  676: 		   node=node(),
<a name="677"/>  677: 		   data={?MODULE,error_in_suite,tag(FinalNotify)}},
<a name="678"/>  678:     ct_event:sync_notify(Event),
<a name="679"/>  679:     ok;
<a name="680"/>  680: <b>end_tc</b>(Mod,Func,{TCPid,Result,[Args]}, Return) when is_pid(TCPid) -&gt;
<a name="681"/>  681:     end_tc(Mod,Func,TCPid,Result,Args,Return);
<a name="682"/>  682: <b>end_tc</b>(Mod,Func,{Result,[Args]}, Return) -&gt;
<a name="end_tc-last_expr"/><a name="683"/>  683: <b>    end_tc</b>(Mod,Func,self(),Result,Args,Return).
<a name="684"/>  684: 
<a name="end_tc-6"/><a name="685"/>  685: <b>end_tc</b>(Mod,IPTC={init_per_testcase,_Func},_TCPid,Result,Args,Return) -&gt;
<a name="686"/>  686:     case end_hook_func(IPTC,Return,IPTC) of
<a name="687"/>  687:         undefined -&gt; ok;
<a name="688"/>  688:         _ -&gt;
<a name="689"/>  689:             %% in case Mod == ct_framework, lookup the suite name
<a name="690"/>  690:             Suite = get_suite_name(Mod, Args),
<a name="691"/>  691:             case ct_hooks:end_tc(Suite,IPTC,Args,Result,Return) of
<a name="692"/>  692:                 '$ct_no_change' -&gt;
<a name="693"/>  693:                     ok;
<a name="694"/>  694:                 HookResult -&gt;
<a name="695"/>  695:                     HookResult
<a name="696"/>  696:             end
<a name="697"/>  697:     end;
<a name="698"/>  698: 
<a name="699"/>  699: <b>end_tc</b>(Mod,Func00,TCPid,Result,Args,Return) -&gt;
<a name="700"/>  700:     %% in case Mod == ct_framework, lookup the suite name
<a name="701"/>  701:     Suite = get_suite_name(Mod, Args),
<a name="702"/>  702:     {OnlyCleanup,Func0} =
<a name="703"/>  703:         case Func00 of
<a name="704"/>  704:             {cleanup,F0} -&gt;
<a name="705"/>  705:                 {true,F0};
<a name="706"/>  706:             _ -&gt;
<a name="707"/>  707:                 {false,Func00}
<a name="708"/>  708:         end,
<a name="709"/>  709:     {Func,FuncSpec,HookFunc} =
<a name="710"/>  710:         case Func0 of
<a name="711"/>  711:             {end_per_testcase_not_run,F} -&gt;
<a name="712"/>  712:                 %% Testcase is completed (skipped or failed), but
<a name="713"/>  713:                 %% end_per_testcase is not run - don't call post-hook.
<a name="714"/>  714:                 {F,F,undefined};
<a name="715"/>  715:             {end_per_testcase,F} -&gt;
<a name="716"/>  716:                 {F,F,Func0};
<a name="717"/>  717:             _ -&gt;
<a name="718"/>  718:                 FS = group_or_func(Func0,Args),
<a name="719"/>  719:                 HF = end_hook_func(Func0,Return,FS),
<a name="720"/>  720:                 {Func0,FS,HF}
<a name="721"/>  721:         end,
<a name="722"/>  722: 
<a name="723"/>  723:     test_server:timetrap_cancel(),
<a name="724"/>  724: 
<a name="725"/>  725:     %% save the testcase process pid so that it can be used
<a name="726"/>  726:     %% to look up the attached trace window later
<a name="727"/>  727:     case ct_util:get_testdata(interpret) of
<a name="728"/>  728: 	{What,kill,_} -&gt;
<a name="729"/>  729: 	    AttPid = ct_util:get_attached(self()),
<a name="730"/>  730: 	    ct_util:set_testdata({interpret,{What,kill,{self(),AttPid}}});
<a name="731"/>  731: 	_ -&gt;
<a name="732"/>  732: 	    ok
<a name="733"/>  733:     end,
<a name="734"/>  734:     if Func == end_per_group; Func == end_per_suite -&gt;
<a name="735"/>  735: 	    %% clean up any saved comments
<a name="736"/>  736: 	    ct_util:match_delete_testdata({comment,'_'});
<a name="737"/>  737:        true -&gt;
<a name="738"/>  738: 	    %% attemp to delete any saved comment for this TC
<a name="739"/>  739: 	    case process_info(TCPid, group_leader) of
<a name="740"/>  740: 		{group_leader,TCGL} -&gt;
<a name="741"/>  741: 		    ct_util:delete_testdata({comment,TCGL});
<a name="742"/>  742: 		_ -&gt;
<a name="743"/>  743: 		    ok
<a name="744"/>  744: 	    end
<a name="745"/>  745:     end,
<a name="746"/>  746:     ct_util:delete_suite_data(last_saved_config),
<a name="747"/>  747: 
<a name="748"/>  748:     {Result1,FinalNotify} =
<a name="749"/>  749:         case HookFunc of
<a name="750"/>  750:             undefined -&gt;
<a name="751"/>  751:                 {ok,Result};
<a name="752"/>  752:             _ when OnlyCleanup -&gt;
<a name="753"/>  753:                 {ok,Result};
<a name="754"/>  754:             _ -&gt;
<a name="755"/>  755:                 case ct_hooks:end_tc(Suite,HookFunc,Args,Result,Return) of
<a name="756"/>  756:                     '$ct_no_change' -&gt;
<a name="757"/>  757:                         {ok,Result};
<a name="758"/>  758:                     HookResult -&gt;
<a name="759"/>  759:                         {HookResult,HookResult}
<a name="760"/>  760:                 end
<a name="761"/>  761:         end,
<a name="762"/>  762:     FinalResult =
<a name="763"/>  763: 	case get('$test_server_framework_test') of
<a name="764"/>  764:             _ when OnlyCleanup -&gt;
<a name="765"/>  765:                 Result1;
<a name="766"/>  766: 	    undefined -&gt;
<a name="767"/>  767: 		%% send sync notification so that event handlers may print
<a name="768"/>  768: 		%% in the log file before it gets closed
<a name="769"/>  769: 		Event = #event{name=tc_done,
<a name="770"/>  770: 			       node=node(),
<a name="771"/>  771: 			       data={Mod,FuncSpec,
<a name="772"/>  772: 				     tag(FinalNotify)}},
<a name="773"/>  773: 		ct_event:sync_notify(Event),
<a name="774"/>  774: 		Result1;
<a name="775"/>  775: 	    Fun -&gt;
<a name="776"/>  776: 		%% send sync notification so that event handlers may print
<a name="777"/>  777: 		%% in the log file before it gets closed
<a name="778"/>  778: 		Event = #event{name=tc_done,
<a name="779"/>  779: 			       node=node(),
<a name="780"/>  780: 			       data={Mod,FuncSpec,
<a name="781"/>  781: 				     tag({'$test_server_framework_test',
<a name="782"/>  782: 					  FinalNotify})}},
<a name="783"/>  783: 		ct_event:sync_notify(Event),
<a name="784"/>  784: 		Fun(end_tc, Return)
<a name="785"/>  785: 	end,    
<a name="786"/>  786: 
<a name="787"/>  787:     case FuncSpec of
<a name="788"/>  788: 	{_,GroupName,_Props} -&gt;
<a name="789"/>  789: 	    if Func == end_per_group -&gt;
<a name="790"/>  790: 		    ct_config:delete_default_config({group,GroupName});
<a name="791"/>  791: 	       true -&gt; ok
<a name="792"/>  792: 	    end,
<a name="793"/>  793: 	    case lists:keysearch(save_config,1,Args) of
<a name="794"/>  794: 		{value,{save_config,SaveConfig}} -&gt;
<a name="795"/>  795: 		    ct_util:save_suite_data(last_saved_config,
<a name="796"/>  796: 					    {Suite,{group,GroupName}},
<a name="797"/>  797: 					    SaveConfig);
<a name="798"/>  798: 		false -&gt;
<a name="799"/>  799: 		    ok
<a name="800"/>  800: 	    end;
<a name="801"/>  801: 	_ -&gt;
<a name="802"/>  802: 	    case lists:keysearch(save_config,1,Args) of
<a name="803"/>  803: 		{value,{save_config,SaveConfig}} -&gt;
<a name="804"/>  804: 		    ct_util:save_suite_data(last_saved_config,
<a name="805"/>  805: 					    {Suite,Func},SaveConfig);
<a name="806"/>  806: 		false -&gt;
<a name="807"/>  807: 		    ok
<a name="808"/>  808: 	    end
<a name="809"/>  809:     end,
<a name="810"/>  810: 
<a name="811"/>  811:     ct_util:reset_silent_connections(),
<a name="812"/>  812: 
<a name="813"/>  813:     %% reset the curr_tc state, or delete this TC from the list of
<a name="814"/>  814:     %% executing cases (if in a parallel group)
<a name="815"/>  815:     ClearCurrTC = fun(Running = [_,_|_]) -&gt;
<a name="816"/>  816: 			  lists:keydelete(Func,2,Running);
<a name="817"/>  817: 		     ({_,{suite0_failed,_}}) -&gt;
<a name="818"/>  818: 			  undefined;
<a name="819"/>  819: 		     ([{_,CurrTC}]) when CurrTC == Func -&gt;
<a name="820"/>  820: 			  undefined;
<a name="821"/>  821: 		     (undefined) -&gt;
<a name="822"/>  822: 			  undefined;
<a name="823"/>  823: 		     (Unexpected) -&gt;
<a name="824"/>  824: 			  {error,{reset_curr_tc,{Mod,Func},Unexpected}}
<a name="825"/>  825: 		  end,
<a name="826"/>  826:     case ct_util:update_testdata(curr_tc, ClearCurrTC) of
<a name="827"/>  827: 	{error,_} = ClearError -&gt;
<a name="828"/>  828: 	    exit(ClearError);
<a name="829"/>  829: 	_ -&gt;
<a name="830"/>  830: 	    ok
<a name="831"/>  831:     end,
<a name="832"/>  832: 
<a name="833"/>  833:     case FinalResult of
<a name="834"/>  834: 	{auto_skip,{sequence_failed,_,_}} -&gt;
<a name="835"/>  835: 	    %% ct_logs:init_tc is never called for a skipped test case
<a name="836"/>  836: 	    %% in a failing sequence, so neither should end_tc	    
<a name="837"/>  837: 	    ok;
<a name="838"/>  838: 	_ -&gt;
<a name="839"/>  839: 	    case ct_logs:end_tc(TCPid) of
<a name="840"/>  840: 		{error,Reason} -&gt;
<a name="841"/>  841: 		    exit({error,{logger,Reason}});
<a name="842"/>  842: 		_ -&gt;
<a name="843"/>  843: 		    ok
<a name="844"/>  844: 	    end
<a name="845"/>  845:     end,
<a name="846"/>  846:     case Func of
<a name="847"/>  847: 	end_per_suite -&gt; 
<a name="848"/>  848: 	    ct_util:match_delete_suite_data({seq,Suite,'_'});
<a name="849"/>  849: 	_ -&gt; 
<a name="850"/>  850: 	    ok
<a name="851"/>  851:     end,
<a name="end_tc-last_expr"/><a name="852"/>  852:     FinalResult.	    
<a name="853"/>  853: 
<a name="854"/>  854: <i>%% This is to make sure that no post_init_per_* is ever called if the</i>
<a name="855"/>  855: <i>%% corresponding pre_init_per_* was not called.</i>
<a name="856"/>  856: <i>%% The skip or fail reasons are those that can be returned from</i>
<a name="857"/>  857: <i>%% init_tc above in situations where we never came to call</i>
<a name="858"/>  858: <i>%% ct_hooks:init_tc/3, e.g. if suite/0 fails, then we never call</i>
<a name="859"/>  859: <i>%% ct_hooks:init_tc for init_per_suite, and thus we must not call</i>
<a name="860"/>  860: <i>%% ct_hooks:end_tc for init_per_suite either.</i>
<a name="end_hook_func-3"/><a name="861"/>  861: <b>end_hook_func</b>({init_per_testcase,_},{auto_skip,{sequence_failed,_,_}},_) -&gt;
<a name="862"/>  862:     undefined;
<a name="863"/>  863: <b>end_hook_func</b>({init_per_testcase,_},{auto_skip,&quot;Repeated test stopped by force_stop option&quot;},_) -&gt;
<a name="864"/>  864:     undefined;
<a name="865"/>  865: <b>end_hook_func</b>({init_per_testcase,_},{fail,{config_name_already_in_use,_}},_) -&gt;
<a name="866"/>  866:     undefined;
<a name="867"/>  867: <b>end_hook_func</b>({init_per_testcase,_},{auto_skip,{InfoFuncError,_}},_)
<a name="868"/>  868:   when InfoFuncError==testcase0_failed;
<a name="869"/>  869:        InfoFuncError==require_failed -&gt;
<a name="870"/>  870:     undefined;
<a name="871"/>  871: <b>end_hook_func</b>(init_per_group,{auto_skip,{InfoFuncError,_}},_)
<a name="872"/>  872:   when InfoFuncError==group0_failed;
<a name="873"/>  873:        InfoFuncError==require_failed -&gt;
<a name="874"/>  874:     undefined;
<a name="875"/>  875: <b>end_hook_func</b>(init_per_suite,{auto_skip,{require_failed_in_suite0,_}},_) -&gt;
<a name="876"/>  876:     undefined;
<a name="877"/>  877: <b>end_hook_func</b>(init_per_suite,{auto_skip,{failed,{error,{suite0_failed,_}}}},_) -&gt;
<a name="878"/>  878:     undefined;
<a name="879"/>  879: <b>end_hook_func</b>(_,_,Default) -&gt;
<a name="end_hook_func-last_expr"/><a name="880"/>  880:     Default.
<a name="881"/>  881: 
<a name="882"/>  882: <i>%% {error,Reason} | {skip,Reason} | {timetrap_timeout,TVal} | </i>
<a name="883"/>  883: <i>%% {testcase_aborted,Reason} | testcase_aborted_or_killed | </i>
<a name="884"/>  884: <i>%% {'EXIT',Reason} | {fail,Reason} | {failed,Reason} |</i>
<a name="885"/>  885: <i>%% {user_timetrap_error,Reason} |</i>
<a name="886"/>  886: <i>%% Other (ignored return value, e.g. 'ok')</i>
<a name="tag-1"/><a name="887"/>  887: <b>tag</b>({'$test_server_framework_test',Result}) -&gt;
<a name="888"/>  888:     case tag(Result) of
<a name="889"/>  889: 	ok      -&gt; Result;
<a name="890"/>  890: 	Failure -&gt; Failure
<a name="891"/>  891:     end;	    
<a name="892"/>  892: <b>tag</b>({skipped,Reason={failed,{_,init_per_testcase,_}}}) -&gt;
<a name="893"/>  893:     {auto_skipped,Reason};
<a name="894"/>  894: <b>tag</b>({STag,Reason}) when STag == skip; STag == skipped -&gt; 
<a name="895"/>  895:     case Reason of
<a name="896"/>  896: 	{failed,{_,init_per_testcase,_}} -&gt; {auto_skipped,Reason};
<a name="897"/>  897: 	_ -&gt; {skipped,Reason}
<a name="898"/>  898:     end;
<a name="899"/>  899: <b>tag</b>({auto_skip,Reason}) -&gt;
<a name="900"/>  900:     {auto_skipped,Reason};
<a name="901"/>  901: <b>tag</b>({fail,Reason}) -&gt;
<a name="902"/>  902:     {failed,{error,Reason}};
<a name="903"/>  903: <b>tag</b>(Failed = {failed,_Reason}) -&gt;
<a name="904"/>  904:     Failed;
<a name="905"/>  905: <b>tag</b>(E = {ETag,_}) when ETag == error; ETag == 'EXIT'; 
<a name="906"/>  906: 			   ETag == timetrap_timeout;
<a name="907"/>  907: 			   ETag == testcase_aborted -&gt; 
<a name="908"/>  908:     {failed,E};
<a name="909"/>  909: <b>tag</b>(E = testcase_aborted_or_killed) -&gt;
<a name="910"/>  910:     {failed,E};
<a name="911"/>  911: <b>tag</b>(UserTimetrap = {user_timetrap_error,_Reason}) -&gt;
<a name="912"/>  912:     UserTimetrap;
<a name="913"/>  913: <b>tag</b>(_Other) -&gt;
<a name="tag-last_expr"/><a name="914"/>  914:     ok.
<a name="915"/>  915: 
<a name="916"/>  916: <i>%%%-----------------------------------------------------------------</i>
<a name="917"/>  917: <i>%%% -spec error_notification(Mod,Func,Args,Error) -&gt; ok</i>
<a name="918"/>  918: <i>%%%      Mod = atom()</i>
<a name="919"/>  919: <i>%%%      Func = atom()</i>
<a name="920"/>  920: <i>%%%      Args = list()</i>
<a name="921"/>  921: <i>%%%      Error = term()</i>
<a name="922"/>  922: <i>%%%</i>
<a name="923"/>  923: <i>%%% This function is called as the result of testcase</i>
<a name="924"/>  924: <i>%%% Func in suite Mod crashing.</i>
<a name="925"/>  925: <i>%%% Error specifies the reason for failing.</i>
<a name="error_notification-4"/><a name="926"/>  926: <b>error_notification</b>(Mod,Func,_Args,{Error,Loc}) -&gt;
<a name="927"/>  927:     ErrorSpec = case Error of
<a name="928"/>  928: 		 {What={_E,_R},Trace} when is_list(Trace) -&gt;
<a name="929"/>  929: 		      What;
<a name="930"/>  930: 		  What -&gt;
<a name="931"/>  931: 		      What
<a name="932"/>  932: 	      end,
<a name="933"/>  933:     ErrorStr = case ErrorSpec of
<a name="934"/>  934: 		 {badmatch,Descr} -&gt;
<a name="935"/>  935:                      Descr1 = io_lib:format(&quot;~tP&quot;,[Descr,10]),
<a name="936"/>  936:                      DescrLength = string:length(Descr1),
<a name="937"/>  937:                      if DescrLength &gt; 50 -&gt;
<a name="938"/>  938: 			     Descr2 = string:slice(Descr1,0,50),
<a name="939"/>  939: 			     io_lib:format(&quot;{badmatch,~ts...}&quot;,[Descr2]);
<a name="940"/>  940: 			true -&gt;
<a name="941"/>  941: 			     io_lib:format(&quot;{badmatch,~ts}&quot;,[Descr1])
<a name="942"/>  942: 		     end;
<a name="943"/>  943: 		 {test_case_failed,Reason} -&gt;
<a name="944"/>  944: 		     case (catch io_lib:format(&quot;{test_case_failed,~ts}&quot;, [Reason])) of
<a name="945"/>  945: 			 {'EXIT',_} -&gt;
<a name="946"/>  946: 			     io_lib:format(&quot;{test_case_failed,~tp}&quot;, [Reason]);
<a name="947"/>  947: 			 Result -&gt; Result
<a name="948"/>  948: 		     end;
<a name="949"/>  949: 		 {'EXIT',_Reason} = EXIT -&gt;
<a name="950"/>  950: 		     io_lib:format(&quot;~tP&quot;, [EXIT,5]);
<a name="951"/>  951: 		 {Spec,_Reason} when is_atom(Spec) -&gt;
<a name="952"/>  952: 		     io_lib:format(&quot;~tw&quot;, [Spec]);
<a name="953"/>  953: 		 Other -&gt;
<a name="954"/>  954: 		     io_lib:format(&quot;~tP&quot;, [Other,5])
<a name="955"/>  955: 	     end,
<a name="956"/>  956:     ErrorHtml =
<a name="957"/>  957: 	&quot;&lt;font color=\&quot;brown\&quot;&gt;&quot; ++ ct_logs:escape_chars(ErrorStr) ++ &quot;&lt;/font&gt;&quot;,
<a name="958"/>  958:     case {Mod,Error} of
<a name="959"/>  959: 	%% some notifications come from the main test_server process
<a name="960"/>  960: 	%% and for these cases the existing comment may not be modified
<a name="961"/>  961: 	{_,{timetrap_timeout,_TVal}} -&gt;
<a name="962"/>  962: 	    ok;
<a name="963"/>  963: 	{_,{testcase_aborted,_Info}} -&gt;
<a name="964"/>  964: 	    ok;
<a name="965"/>  965: 	{_,testcase_aborted_or_killed} -&gt;
<a name="966"/>  966: 	    ok;
<a name="967"/>  967: 	{undefined,_OtherError} -&gt;
<a name="968"/>  968: 	    ok;
<a name="969"/>  969: 	_ -&gt;			     
<a name="970"/>  970: 	    %% this notification comes from the test case process, so
<a name="971"/>  971: 	    %% we can add error info to comment with test_server:comment/1
<a name="972"/>  972: 	    case ct_util:get_testdata({comment,group_leader()}) of
<a name="973"/>  973: 		undefined -&gt;
<a name="974"/>  974: 		    test_server:comment(ErrorHtml);
<a name="975"/>  975: 		Comment -&gt;
<a name="976"/>  976: 		    CommentHtml = 
<a name="977"/>  977: 			&quot;&lt;font color=\&quot;green\&quot;&gt;&quot; ++ &quot;(&quot; ++ &quot;&lt;/font&gt;&quot;
<a name="978"/>  978: 			++ Comment ++ 
<a name="979"/>  979: 			&quot;&lt;font color=\&quot;green\&quot;&gt;&quot; ++ &quot;)&quot; ++ &quot;&lt;/font&gt;&quot;,
<a name="980"/>  980: 		    Str = io_lib:format(&quot;~ts   ~ts&quot;, [ErrorHtml,CommentHtml]),
<a name="981"/>  981: 		    test_server:comment(Str)
<a name="982"/>  982: 	    end
<a name="983"/>  983:     end,
<a name="984"/>  984: 
<a name="985"/>  985:     PrintError = fun(ErrorFormat, ErrorArgs) -&gt;
<a name="986"/>  986:                       Div = &quot;\n- - - - - - - - - - - - - - - - - - - &quot;
<a name="987"/>  987:                             &quot;- - - - - - - - - - - - - - - - - - - - -\n&quot;,
<a name="988"/>  988: 		       ErrorStr2 = io_lib:format(ErrorFormat, ErrorArgs),
<a name="989"/>  989:                       io:format(?def_gl, &quot;~ts~n&quot;, [lists:concat([Div,ErrorStr2,Div])]),
<a name="990"/>  990: 		       Link =
<a name="991"/>  991: 			   &quot;\n\n&lt;a href=\&quot;#end\&quot;&gt;&quot;
<a name="992"/>  992: 			   &quot;Full error description and stacktrace&quot;
<a name="993"/>  993: 			   &quot;&lt;/a&gt;&quot;,
<a name="994"/>  994: 		       ErrorHtml2 = ct_logs:escape_chars(ErrorStr2),
<a name="995"/>  995: 		       ct_logs:tc_log(ct_error_notify,
<a name="996"/>  996: 				      ?MAX_IMPORTANCE,
<a name="997"/>  997: 				      &quot;CT Error Notification&quot;,
<a name="998"/>  998:                                       &quot;~ts&quot;, [ErrorHtml2++Link],
<a name="999"/>  999:                                       [])
<a name="1000"/> 1000: 	       end,
<a name="1001"/> 1001:     case Loc of
<a name="1002"/> 1002: 	[{?MODULE,error_in_suite}] -&gt;
<a name="1003"/> 1003: 	    PrintError(&quot;Error in suite detected: ~ts&quot;, [ErrorStr]);
<a name="1004"/> 1004: 
<a name="1005"/> 1005: 	R when R == unknown; R == undefined -&gt;
<a name="1006"/> 1006: 	    PrintError(&quot;Error detected: ~ts&quot;, [ErrorStr]);
<a name="1007"/> 1007: 
<a name="1008"/> 1008: 	%% if a function specified by all/0 does not exist, we
<a name="1009"/> 1009: 	%% pick up undef here
<a name="1010"/> 1010: 	[{LastMod,LastFunc}|_] when ErrorStr == &quot;undef&quot; -&gt;
<a name="1011"/> 1011: 	    PrintError(&quot;~w:~tw could not be executed~nReason: ~ts&quot;,
<a name="1012"/> 1012: 		     [LastMod,LastFunc,ErrorStr]);
<a name="1013"/> 1013: 
<a name="1014"/> 1014: 	[{LastMod,LastFunc}|_] -&gt;
<a name="1015"/> 1015: 	    PrintError(&quot;~w:~tw failed~nReason: ~ts&quot;, [LastMod,LastFunc,ErrorStr]);
<a name="1016"/> 1016: 	    
<a name="1017"/> 1017: 	[{LastMod,LastFunc,LastLine}|_] -&gt;
<a name="1018"/> 1018: 	    %% print error to console, we are only
<a name="1019"/> 1019: 	    %% interested in the last executed expression
<a name="1020"/> 1020: 	    PrintError(&quot;~w:~tw failed on line ~w~nReason: ~ts&quot;,
<a name="1021"/> 1021: 		     [LastMod,LastFunc,LastLine,ErrorStr]),
<a name="1022"/> 1022: 	    
<a name="1023"/> 1023: 	    case ct_util:read_suite_data({seq,Mod,Func}) of
<a name="1024"/> 1024: 		undefined -&gt;
<a name="1025"/> 1025: 		    ok;
<a name="1026"/> 1026: 		Seq -&gt;
<a name="1027"/> 1027: 		    SeqTCs = ct_util:read_suite_data({seq,Mod,Seq}),
<a name="1028"/> 1028: 		    mark_as_failed(Seq,Mod,Func,SeqTCs)
<a name="1029"/> 1029: 	    end	    
<a name="1030"/> 1030:     end,
<a name="error_notification-last_expr"/><a name="1031"/> 1031:     ok.
<a name="1032"/> 1032: 
<a name="1033"/> 1033: <i>%% cases in seq that have already run</i>
<a name="mark_as_failed-4"/><a name="1034"/> 1034: <b>mark_as_failed</b>(Seq,Mod,Func,[Func|TCs]) -&gt;
<a name="1035"/> 1035:     mark_as_failed1(Seq,Mod,Func,TCs);
<a name="1036"/> 1036: <b>mark_as_failed</b>(Seq,Mod,Func,[_TC|TCs]) -&gt;
<a name="1037"/> 1037:     mark_as_failed(Seq,Mod,Func,TCs);
<a name="1038"/> 1038: <b>mark_as_failed</b>(_,_,_,[]) -&gt;
<a name="1039"/> 1039:     ok;
<a name="1040"/> 1040: <b>mark_as_failed</b>(_,_,_,undefined) -&gt;
<a name="mark_as_failed-last_expr"/><a name="1041"/> 1041:     ok.
<a name="1042"/> 1042: 
<a name="1043"/> 1043: <i>%% mark rest of cases in seq to be skipped</i>
<a name="mark_as_failed1-4"/><a name="1044"/> 1044: <b>mark_as_failed1</b>(Seq,Mod,Func,[TC|TCs]) -&gt;
<a name="1045"/> 1045:     ct_util:save_suite_data({seq,Mod,TC},{failed,Seq,Func}),
<a name="1046"/> 1046:     mark_as_failed1(Seq,Mod,Func,TCs);
<a name="1047"/> 1047: <b>mark_as_failed1</b>(_,_,_,[]) -&gt;
<a name="mark_as_failed1-last_expr"/><a name="1048"/> 1048:     ok.
<a name="1049"/> 1049: 
<a name="group_or_func-2"/><a name="1050"/> 1050: <b>group_or_func</b>(Func, Config) when Func == init_per_group; 
<a name="1051"/> 1051: 				 Func == end_per_group -&gt;
<a name="1052"/> 1052:     case ?val(tc_group_properties, Config) of
<a name="1053"/> 1053: 	undefined -&gt;
<a name="1054"/> 1054: 	    {Func,unknown,[]};
<a name="1055"/> 1055: 	GrProps -&gt;
<a name="1056"/> 1056: 	    GrName = ?val(name,GrProps),
<a name="1057"/> 1057: 	    {Func,GrName,proplists:delete(name,GrProps)}
<a name="1058"/> 1058:     end;	  
<a name="1059"/> 1059: <b>group_or_func</b>(Func, _Config) -&gt;
<a name="group_or_func-last_expr"/><a name="1060"/> 1060:     Func.
<a name="1061"/> 1061: 
<a name="1062"/> 1062: <i>%%%-----------------------------------------------------------------</i>
<a name="1063"/> 1063: <i>%%% -spec get_suite(Mod, Func) -&gt; Tests</i>
<a name="1064"/> 1064: <i>%%%</i>
<a name="1065"/> 1065: <i>%%% Called from test_server for every suite (Func==all)</i>
<a name="1066"/> 1066: <i>%%% and every test case. If the former, all test cases in the suite</i>
<a name="1067"/> 1067: <i>%%% should be returned.</i>
<a name="1068"/> 1068: 
<a name="get_suite-2"/><a name="1069"/> 1069: <b>get_suite</b>(Mod, all) -&gt;
<a name="1070"/> 1070:     case safe_apply_groups_0(Mod,{ok,[]}) of
<a name="1071"/> 1071:         {ok,GroupDefs} -&gt;
<a name="1072"/> 1072:             try ct_groups:find_groups(Mod, all, all, GroupDefs) of
<a name="1073"/> 1073:                 ConfTests when is_list(ConfTests) -&gt;
<a name="1074"/> 1074:                     get_all(Mod, ConfTests)
<a name="1075"/> 1075:             catch
<a name="1076"/> 1076:                 throw:{error,Error} -&gt;
<a name="1077"/> 1077:                     [{?MODULE,error_in_suite,[[{error,Error}]]}];
<a name="1078"/> 1078:                 _:Error:S -&gt;
<a name="1079"/> 1079:                     [{?MODULE,error_in_suite,[[{error,{Error,S}}]]}]
<a name="1080"/> 1080:             end;
<a name="1081"/> 1081:         {error,{bad_return,_Bad}} -&gt;
<a name="1082"/> 1082: 	    E = &quot;Bad return value from &quot;++atom_to_list(Mod)++&quot;:groups/0&quot;,
<a name="1083"/> 1083: 	    [{?MODULE,error_in_suite,[[{error,list_to_atom(E)}]]}];
<a name="1084"/> 1084:         {error,{bad_hook_return,Bad}} -&gt;
<a name="1085"/> 1085: 	    E = &quot;Bad return value from post_groups/2 hook function&quot;,
<a name="1086"/> 1086: 	    [{?MODULE,error_in_suite,[[{error,{list_to_atom(E),Bad}}]]}];
<a name="1087"/> 1087:         {error,{failed,ExitReason}} -&gt;
<a name="1088"/> 1088: 	    case ct_util:get_testdata({error_in_suite,Mod}) of
<a name="1089"/> 1089: 		undefined -&gt;
<a name="1090"/> 1090: 		    ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="1091"/> 1091: 					   &quot;~w:groups/0 failed: ~p~n&quot;,
<a name="1092"/> 1092: 					   [Mod,ExitReason]),
<a name="1093"/> 1093: 		    io:format(?def_gl, ErrStr, []),
<a name="1094"/> 1094: 		    %% save the error info so it doesn't get printed twice
<a name="1095"/> 1095: 		    ct_util:set_testdata_async({{error_in_suite,Mod},
<a name="1096"/> 1096: 						ExitReason});
<a name="1097"/> 1097: 		_ExitReason -&gt;
<a name="1098"/> 1098: 		    ct_util:delete_testdata({error_in_suite,Mod})
<a name="1099"/> 1099: 	    end,
<a name="1100"/> 1100: 	    Reason = list_to_atom(atom_to_list(Mod)++&quot;:groups/0 failed&quot;),
<a name="1101"/> 1101: 	    [{?MODULE,error_in_suite,[[{error,Reason}]]}];
<a name="1102"/> 1102:         {error,What} -&gt;
<a name="1103"/> 1103:             [{?MODULE,error_in_suite,[[{error,What}]]}]
<a name="1104"/> 1104:     end;
<a name="1105"/> 1105: 
<a name="1106"/> 1106: <i>%%!============================================================</i>
<a name="1107"/> 1107: <i>%%! Note: The handling of sequences in get_suite/2 and get_all/2</i>
<a name="1108"/> 1108: <i>%%! is deprecated and should be removed at some point...</i>
<a name="1109"/> 1109: <i>%%!============================================================</i>
<a name="1110"/> 1110: 
<a name="1111"/> 1111: <i>%% group</i>
<a name="1112"/> 1112: <b>get_suite</b>(Mod, Group={conf,Props,_Init,TCs,_End}) -&gt;
<a name="1113"/> 1113:     case safe_apply_groups_0(Mod,{ok,[Group]}) of
<a name="1114"/> 1114:         {ok,GroupDefs} -&gt;
<a name="1115"/> 1115:             Name = ?val(name, Props),
<a name="1116"/> 1116:             try ct_groups:find_groups(Mod, Name, TCs, GroupDefs) of
<a name="1117"/> 1117:                 [] -&gt;
<a name="1118"/> 1118:                     [];
<a name="1119"/> 1119:                 ConfTests when is_list(ConfTests) -&gt;
<a name="1120"/> 1120:                     case lists:member(skipped, Props) of
<a name="1121"/> 1121:                         true -&gt;
<a name="1122"/> 1122:                             %% a *subgroup* specified *only* as skipped (and not
<a name="1123"/> 1123:                             %% as an explicit test) should not be returned, or
<a name="1124"/> 1124:                             %% init/end functions for top groups will be executed
<a name="1125"/> 1125:                             try ?val(name, element(2, hd(ConfTests))) of
<a name="1126"/> 1126:                                 Name -&gt;		% top group
<a name="1127"/> 1127:                                     ct_groups:delete_subs(ConfTests, ConfTests);
<a name="1128"/> 1128:                                 _ -&gt; []
<a name="1129"/> 1129:                             catch
<a name="1130"/> 1130:                                 _:_ -&gt; []
<a name="1131"/> 1131:                             end;
<a name="1132"/> 1132:                         false -&gt;
<a name="1133"/> 1133:                             ConfTests1 = ct_groups:delete_subs(ConfTests,
<a name="1134"/> 1134:                                                                ConfTests),
<a name="1135"/> 1135:                             case ?val(override, Props) of
<a name="1136"/> 1136:                                 undefined -&gt;
<a name="1137"/> 1137:                                     ConfTests1;
<a name="1138"/> 1138:                                 [] -&gt;
<a name="1139"/> 1139:                                     ConfTests1;
<a name="1140"/> 1140:                                 ORSpec -&gt;
<a name="1141"/> 1141:                                     ORSpec1 = if is_tuple(ORSpec) -&gt; [ORSpec];
<a name="1142"/> 1142:                                                  true -&gt; ORSpec end,
<a name="1143"/> 1143:                                     ct_groups:search_and_override(ConfTests1,
<a name="1144"/> 1144:                                                                   ORSpec1, Mod)
<a name="1145"/> 1145:                             end
<a name="1146"/> 1146:                     end
<a name="1147"/> 1147:             catch
<a name="1148"/> 1148:                 throw:{error,Error} -&gt;
<a name="1149"/> 1149:                     [{?MODULE,error_in_suite,[[{error,Error}]]}];
<a name="1150"/> 1150:                 _:Error:S -&gt;
<a name="1151"/> 1151:                     [{?MODULE,error_in_suite,[[{error,{Error,S}}]]}]
<a name="1152"/> 1152:             end;
<a name="1153"/> 1153:         {error,{bad_return,_Bad}} -&gt;
<a name="1154"/> 1154: 	    E = &quot;Bad return value from &quot;++atom_to_list(Mod)++&quot;:groups/0&quot;,
<a name="1155"/> 1155: 	    [{?MODULE,error_in_suite,[[{error,list_to_atom(E)}]]}];
<a name="1156"/> 1156:         {error,{bad_hook_return,Bad}} -&gt;
<a name="1157"/> 1157:             E = &quot;Bad return value from post_groups/2 hook function&quot;,
<a name="1158"/> 1158: 	    [{?MODULE,error_in_suite,[[{error,{list_to_atom(E),Bad}}]]}];
<a name="1159"/> 1159:         {error,{failed,ExitReason}} -&gt;
<a name="1160"/> 1160: 	    case ct_util:get_testdata({error_in_suite,Mod}) of
<a name="1161"/> 1161: 		undefined -&gt;
<a name="1162"/> 1162: 		    ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="1163"/> 1163: 					   &quot;~w:groups/0 failed: ~p~n&quot;,
<a name="1164"/> 1164: 					   [Mod,ExitReason]),
<a name="1165"/> 1165: 		    io:format(?def_gl, ErrStr, []),
<a name="1166"/> 1166: 		    %% save the error info so it doesn't get printed twice
<a name="1167"/> 1167: 		    ct_util:set_testdata_async({{error_in_suite,Mod},
<a name="1168"/> 1168: 						ExitReason});
<a name="1169"/> 1169: 		_ExitReason -&gt;
<a name="1170"/> 1170: 		    ct_util:delete_testdata({error_in_suite,Mod})
<a name="1171"/> 1171: 	    end,
<a name="1172"/> 1172: 	    Reason = list_to_atom(atom_to_list(Mod)++&quot;:groups/0 failed&quot;),
<a name="1173"/> 1173: 	    [{?MODULE,error_in_suite,[[{error,Reason}]]}];
<a name="1174"/> 1174:          {error,What} -&gt;
<a name="1175"/> 1175:             [{?MODULE,error_in_suite,[[{error,What}]]}]
<a name="1176"/> 1176:     end;
<a name="1177"/> 1177: 
<a name="1178"/> 1178: <i>%% testcase</i>
<a name="1179"/> 1179: <b>get_suite</b>(Mod, Name) -&gt;
<a name="get_suite-last_expr"/><a name="1180"/> 1180: <b>    get_seq</b>(Mod, Name).
<a name="1181"/> 1181: 
<a name="1182"/> 1182: <i>%%%-----------------------------------------------------------------</i>
<a name="1183"/> 1183: 
<a name="get_all_cases-1"/><a name="1184"/> 1184: <b>get_all_cases</b>(Suite) -&gt;
<a name="get_all_cases-last_expr"/><a name="1185"/> 1185: <b>    case get_suite</b>(Suite, all) of
<a name="1186"/> 1186: 	[{?MODULE,error_in_suite,[[{error,_}=Error]]}] -&gt;
<a name="1187"/> 1187: 		Error;
<a name="1188"/> 1188: 	[{?MODULE,error_in_suite,[[Error]]}] -&gt;
<a name="1189"/> 1189: 	    {error,Error};
<a name="1190"/> 1190: 	Tests -&gt;
<a name="1191"/> 1191: 	    Cases = get_all_cases1(Suite, Tests),
<a name="1192"/> 1192: 	    ?rev(lists:foldl(fun(TC, TCs) -&gt;
<a name="1193"/> 1193: 				     case lists:member(TC, TCs) of
<a name="1194"/> 1194: 				      true  -&gt; TCs;
<a name="1195"/> 1195: 					 false -&gt; [TC | TCs]
<a name="1196"/> 1196: 				     end
<a name="1197"/> 1197: 			     end, [], Cases))
<a name="1198"/> 1198:     end.
<a name="1199"/> 1199: 
<a name="get_all_cases1-2"/><a name="1200"/> 1200: <b>get_all_cases1</b>(Suite, [{conf,_Props,_Init,GrTests,_End} | Tests]) -&gt;
<a name="1201"/> 1201:     get_all_cases1(Suite, GrTests) ++ get_all_cases1(Suite, Tests);
<a name="1202"/> 1202: 
<a name="1203"/> 1203: <b>get_all_cases1</b>(Suite, [Test | Tests]) when is_atom(Test) -&gt;
<a name="1204"/> 1204:     [{Suite,Test} | get_all_cases1(Suite, Tests)];
<a name="1205"/> 1205: 
<a name="1206"/> 1206: <b>get_all_cases1</b>(Suite, [Test | Tests]) -&gt;
<a name="1207"/> 1207:     [Test | get_all_cases1(Suite, Tests)];
<a name="1208"/> 1208: 
<a name="1209"/> 1209: <b>get_all_cases1</b>(_, []) -&gt;
<a name="get_all_cases1-last_expr"/><a name="1210"/> 1210:     [].
<a name="1211"/> 1211: 
<a name="1212"/> 1212: <i>%%%-----------------------------------------------------------------</i>
<a name="1213"/> 1213: 
<a name="get_all-2"/><a name="1214"/> 1214: <b>get_all</b>(Mod, ConfTests) -&gt;
<a name="get_all-last_expr"/><a name="1215"/> 1215: <b>    case safe_apply_all_0</b>(Mod) of
<a name="1216"/> 1216:         {ok,AllTCs} -&gt;
<a name="1217"/> 1217:             %% expand group references using ConfTests
<a name="1218"/> 1218:             try ct_groups:expand_groups(AllTCs, ConfTests, Mod) of
<a name="1219"/> 1219:                 {error,_} = Error -&gt;
<a name="1220"/> 1220:                     [{?MODULE,error_in_suite,[[Error]]}];
<a name="1221"/> 1221:                 Tests0 -&gt;
<a name="1222"/> 1222:                     Tests = ct_groups:delete_subs(Tests0, Tests0),
<a name="1223"/> 1223:                     expand_tests(Mod, Tests)
<a name="1224"/> 1224:             catch
<a name="1225"/> 1225:                 throw:{error,Error} -&gt;
<a name="1226"/> 1226:                     [{?MODULE,error_in_suite,[[{error,Error}]]}];
<a name="1227"/> 1227:                 _:Error:S -&gt;
<a name="1228"/> 1228:                     [{?MODULE,error_in_suite,[[{error,{Error,S}}]]}]
<a name="1229"/> 1229:             end;
<a name="1230"/> 1230:         Skip = {skip,_Reason} -&gt;
<a name="1231"/> 1231: 	    Skip;
<a name="1232"/> 1232:         {error,undef} -&gt;
<a name="1233"/> 1233:             Reason =
<a name="1234"/> 1234:                 case code:which(Mod) of
<a name="1235"/> 1235:                     non_existing -&gt;
<a name="1236"/> 1236:                         list_to_atom(
<a name="1237"/> 1237:                           atom_to_list(Mod)++
<a name="1238"/> 1238:                               &quot; cannot be compiled or loaded&quot;);
<a name="1239"/> 1239:                     _ -&gt;
<a name="1240"/> 1240:                         list_to_atom(
<a name="1241"/> 1241:                           atom_to_list(Mod)++&quot;:all/0 is missing&quot;)
<a name="1242"/> 1242:                 end,
<a name="1243"/> 1243:             %% this makes test_server call error_in_suite as first
<a name="1244"/> 1244:             %% (and only) test case so we can report Reason properly
<a name="1245"/> 1245:             [{?MODULE,error_in_suite,[[{error,Reason}]]}];
<a name="1246"/> 1246: 	{error,{bad_return,_Bad}} -&gt;
<a name="1247"/> 1247: 	    Reason =
<a name="1248"/> 1248: 		list_to_atom(&quot;Bad return value from &quot;++
<a name="1249"/> 1249: 				 atom_to_list(Mod)++&quot;:all/0&quot;),
<a name="1250"/> 1250: 	    [{?MODULE,error_in_suite,[[{error,Reason}]]}];
<a name="1251"/> 1251:         {error,{bad_hook_return,Bad}} -&gt;
<a name="1252"/> 1252: 	    Reason =
<a name="1253"/> 1253: 		list_to_atom(&quot;Bad return value from post_all/3 hook function&quot;),
<a name="1254"/> 1254: 	    [{?MODULE,error_in_suite,[[{error,{Reason,Bad}}]]}];
<a name="1255"/> 1255:         {error,{failed,ExitReason}} -&gt;
<a name="1256"/> 1256: 	    case ct_util:get_testdata({error_in_suite,Mod}) of
<a name="1257"/> 1257: 		undefined -&gt;
<a name="1258"/> 1258: 		    ErrStr = io_lib:format(&quot;~n*** ERROR *** &quot;
<a name="1259"/> 1259: 					   &quot;~w:all/0 failed: ~tp~n&quot;,
<a name="1260"/> 1260: 					   [Mod,ExitReason]),
<a name="1261"/> 1261: 		    io:format(?def_gl, &quot;~ts&quot;, [ErrStr]),
<a name="1262"/> 1262: 		    %% save the error info so it doesn't get printed twice
<a name="1263"/> 1263: 		    ct_util:set_testdata_async({{error_in_suite,Mod},
<a name="1264"/> 1264: 						ExitReason});
<a name="1265"/> 1265: 		_ExitReason -&gt;
<a name="1266"/> 1266: 		    ct_util:delete_testdata({error_in_suite,Mod})
<a name="1267"/> 1267: 	    end,
<a name="1268"/> 1268: 	    Reason = list_to_atom(atom_to_list(Mod)++&quot;:all/0 failed&quot;),
<a name="1269"/> 1269: 	    %% this makes test_server call error_in_suite as first
<a name="1270"/> 1270: 	    %% (and only) test case so we can report Reason properly
<a name="1271"/> 1271: 	    [{?MODULE,error_in_suite,[[{error,Reason}]]}];
<a name="1272"/> 1272:         {error,What} -&gt;
<a name="1273"/> 1273:             [{?MODULE,error_in_suite,[[{error,What}]]}]
<a name="1274"/> 1274:     end.
<a name="1275"/> 1275: 
<a name="1276"/> 1276: <i>%%!============================================================</i>
<a name="1277"/> 1277: <i>%%! The support for sequences by means of using sequences/0</i>
<a name="1278"/> 1278: <i>%%! will be removed in OTP R15. The code below is only kept </i>
<a name="1279"/> 1279: <i>%%! for backwards compatibility. From OTP R13 groups with</i>
<a name="1280"/> 1280: <i>%%! sequence property should be used instead!</i>
<a name="1281"/> 1281: <i>%%!============================================================</i>
<a name="1282"/> 1282: <i>%%!============================================================</i>
<a name="1283"/> 1283: <i>%%! START OF DEPRECATED SUPPORT FOR SEQUENCES ---&gt;</i>
<a name="1284"/> 1284: 
<a name="get_seq-2"/><a name="1285"/> 1285: <b>get_seq</b>(Mod, Func) -&gt;
<a name="get_seq-last_expr"/><a name="1286"/> 1286: <b>    case ct_util:read_suite_data</b>({seq,Mod,Func}) of
<a name="1287"/> 1287: 	undefined -&gt;
<a name="1288"/> 1288: 	    case catch apply(Mod,sequences,[]) of
<a name="1289"/> 1289: 		{'EXIT',_} -&gt;
<a name="1290"/> 1290: 		    [];
<a name="1291"/> 1291: 		Seqs -&gt;
<a name="1292"/> 1292: 		    case lists:keysearch(Func,1,Seqs) of
<a name="1293"/> 1293: 			{value,{Func,SeqTCs}} -&gt;			    
<a name="1294"/> 1294: 			    case catch save_seq(Mod,Func,SeqTCs) of
<a name="1295"/> 1295: 				{error,What} -&gt;
<a name="1296"/> 1296: 				    [{?MODULE,error_in_suite,[[{error,What}]]}];
<a name="1297"/> 1297: 				_ -&gt;
<a name="1298"/> 1298: 				    SeqTCs
<a name="1299"/> 1299: 			    end;
<a name="1300"/> 1300: 			false -&gt;
<a name="1301"/> 1301: 			    []
<a name="1302"/> 1302: 		    end
<a name="1303"/> 1303: 	    end;
<a name="1304"/> 1304: 	TCs when is_list(TCs) -&gt;
<a name="1305"/> 1305: 	    TCs;
<a name="1306"/> 1306: 	_ -&gt;
<a name="1307"/> 1307: 	    []
<a name="1308"/> 1308:     end.
<a name="1309"/> 1309: 
<a name="save_seqs-2"/><a name="1310"/> 1310: <b>save_seqs</b>(Mod,AllTCs) -&gt;
<a name="save_seqs-last_expr"/><a name="1311"/> 1311: <b>    case lists:keymember</b>(sequence,1,AllTCs) of
<a name="1312"/> 1312: 	true -&gt;
<a name="1313"/> 1313: 	    case catch apply(Mod,sequences,[]) of
<a name="1314"/> 1314: 		{'EXIT',_} -&gt; 
<a name="1315"/> 1315: 		    Reason = list_to_atom(atom_to_list(Mod)++
<a name="1316"/> 1316: 					  &quot;:sequences/0 is missing&quot;),
<a name="1317"/> 1317: 		    throw({error,Reason});
<a name="1318"/> 1318: 		Seqs -&gt;
<a name="1319"/> 1319: 		    save_seqs(Mod,AllTCs,Seqs,AllTCs)
<a name="1320"/> 1320: 	    end;
<a name="1321"/> 1321: 	false -&gt;
<a name="1322"/> 1322: 	    AllTCs
<a name="1323"/> 1323:     end.
<a name="1324"/> 1324:     
<a name="save_seqs-4"/><a name="1325"/> 1325: <b>save_seqs</b>(Mod,[{sequence,Seq}|TCs],Seqs,All) -&gt;
<a name="1326"/> 1326:     case lists:keysearch(Seq,1,Seqs) of
<a name="1327"/> 1327: 	{value,{Seq,SeqTCs}} -&gt;
<a name="1328"/> 1328: 	    save_seq(Mod,Seq,SeqTCs,All),
<a name="1329"/> 1329: 	    [Seq|save_seqs(Mod,TCs,Seqs,All)];
<a name="1330"/> 1330: 	false -&gt;
<a name="1331"/> 1331: 	    Reason = list_to_atom(
<a name="1332"/> 1332: 		       atom_to_list(Seq)++&quot; is missing in &quot;++
<a name="1333"/> 1333: 		       atom_to_list(Mod)),
<a name="1334"/> 1334: 	    throw({error,Reason})
<a name="1335"/> 1335:     end;
<a name="1336"/> 1336: <b>save_seqs</b>(Mod,[TC|TCs],Seqs,All) -&gt;
<a name="1337"/> 1337:     [TC|save_seqs(Mod,TCs,Seqs,All)];
<a name="1338"/> 1338: <b>save_seqs</b>(_,[],_,_) -&gt;
<a name="save_seqs-last_expr"/><a name="1339"/> 1339:     [].
<a name="1340"/> 1340: 
<a name="save_seq-3"/><a name="1341"/> 1341: <b>save_seq</b>(Mod,Seq,SeqTCs) -&gt;
<a name="save_seq-last_expr"/><a name="1342"/> 1342: <b>    save_seq</b>(Mod,Seq,SeqTCs,apply(Mod,all,[])).
<a name="1343"/> 1343:     
<a name="save_seq-4"/><a name="1344"/> 1344: <b>save_seq</b>(Mod,Seq,SeqTCs,All) -&gt;
<a name="1345"/> 1345:     check_private(Seq,SeqTCs,All),
<a name="1346"/> 1346:     check_multiple(Mod,Seq,SeqTCs),
<a name="1347"/> 1347:     ct_util:save_suite_data({seq,Mod,Seq},SeqTCs),
<a name="save_seq-last_expr"/><a name="1348"/> 1348: <b>    lists:foreach</b>(fun(TC) -&gt; 
<a name="1349"/> 1349: 			  ct_util:save_suite_data({seq,Mod,TC},Seq)
<a name="1350"/> 1350: 		  end, SeqTCs).
<a name="1351"/> 1351: 
<a name="check_private-3"/><a name="1352"/> 1352: <b>check_private</b>(Seq,TCs,All) -&gt;    
<a name="1353"/> 1353:     Bad = lists:filter(fun(TC) -&gt; lists:member(TC,All) end, TCs),
<a name="check_private-last_expr"/><a name="1354"/> 1354:     if Bad /= [] -&gt;
<a name="1355"/> 1355: 	    Reason = io_lib:format(&quot;regular test cases not allowed in sequence ~tp: &quot;
<a name="1356"/> 1356: 				   &quot;~tp&quot;,[Seq,Bad]),
<a name="1357"/> 1357: 	    throw({error,list_to_atom(lists:flatten(Reason))});
<a name="1358"/> 1358:        true -&gt;
<a name="1359"/> 1359: 	    ok
<a name="1360"/> 1360:     end.
<a name="1361"/> 1361: 
<a name="check_multiple-3"/><a name="1362"/> 1362: <b>check_multiple</b>(Mod,Seq,TCs) -&gt;
<a name="1363"/> 1363:     Bad = lists:filter(fun(TC) -&gt;
<a name="1364"/> 1364: 			       case ct_util:read_suite_data({seq,Mod,TC}) of
<a name="1365"/> 1365: 				   Seq1 when Seq1 /= undefined, Seq1 /= Seq -&gt; 
<a name="1366"/> 1366: 				       true;
<a name="1367"/> 1367: 
<a name="1368"/> 1368: 				   _ -&gt; false
<a name="1369"/> 1369: 			       end
<a name="1370"/> 1370: 		       end,TCs),
<a name="check_multiple-last_expr"/><a name="1371"/> 1371:     if Bad /= [] -&gt;
<a name="1372"/> 1372: 	    Reason = io_lib:format(&quot;test cases found in multiple sequences: &quot;
<a name="1373"/> 1373: 				   &quot;~tp&quot;,[Bad]),
<a name="1374"/> 1374: 	    throw({error,list_to_atom(lists:flatten(Reason))});
<a name="1375"/> 1375:        true -&gt;
<a name="1376"/> 1376: 	    ok
<a name="1377"/> 1377:     end.
<a name="1378"/> 1378: 
<a name="1379"/> 1379: <i>%%! &lt;---  END OF DEPRECATED SUPPORT FOR SEQUENCES</i>
<a name="1380"/> 1380: <i>%%!============================================================</i>
<a name="1381"/> 1381: 
<a name="1382"/> 1382: <i>%% let test_server call this function as a testcase only so that</i>
<a name="1383"/> 1383: <i>%% the user may see info about what's missing in the suite</i>
<a name="error_in_suite-1"/><a name="1384"/> 1384: <b>error_in_suite</b>(Config) -&gt;
<a name="1385"/> 1385:     Reason = test_server:lookup_config(error,Config),
<a name="error_in_suite-last_expr"/><a name="1386"/> 1386: <b>    exit</b>(Reason).
<a name="1387"/> 1387: 
<a name="1388"/> 1388: <i>%% if init_per_suite and end_per_suite are missing in the suite,</i>
<a name="1389"/> 1389: <i>%% these will be called instead (without any trace of them in the</i>
<a name="1390"/> 1390: <i>%% log files), only so that it's possible to call hook functions</i>
<a name="1391"/> 1391: <i>%% for configuration</i>
<a name="init_per_suite-1"/><a name="1392"/> 1392: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="1393"/> 1393:     Config.
<a name="1394"/> 1394: 
<a name="end_per_suite-1"/><a name="1395"/> 1395: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="1396"/> 1396:     ok.
<a name="1397"/> 1397: 
<a name="1398"/> 1398: <i>%% if the group config functions are missing in the suite,</i>
<a name="1399"/> 1399: <i>%% use these instead</i>
<a name="init_per_group-2"/><a name="1400"/> 1400: <b>init_per_group</b>(GroupName, Config) -&gt;
<a name="1401"/> 1401:     ct:comment(io_lib:format(&quot;start of ~tp&quot;, [GroupName])),
<a name="1402"/> 1402:     ct_logs:log(&quot;TEST INFO&quot;, &quot;init_per_group/2 for ~tw missing &quot;
<a name="1403"/> 1403: 		&quot;in suite, using default.&quot;,
<a name="1404"/> 1404: 		[GroupName]),
<a name="init_per_group-last_expr"/><a name="1405"/> 1405:     Config.
<a name="1406"/> 1406: 
<a name="end_per_group-2"/><a name="1407"/> 1407: <b>end_per_group</b>(GroupName, _) -&gt;
<a name="1408"/> 1408:     ct:comment(io_lib:format(&quot;end of ~tp&quot;, [GroupName])),
<a name="1409"/> 1409:     ct_logs:log(&quot;TEST INFO&quot;, &quot;end_per_group/2 for ~tw missing &quot;
<a name="1410"/> 1410: 		&quot;in suite, using default.&quot;,
<a name="1411"/> 1411: 		[GroupName]),
<a name="end_per_group-last_expr"/><a name="1412"/> 1412:     ok.
<a name="1413"/> 1413:     
<a name="1414"/> 1414: <i>%%%-----------------------------------------------------------------</i>
<a name="1415"/> 1415: <i>%%% -spec report(What,Data) -&gt; ok</i>
<a name="report-2"/><a name="1416"/> 1416: <b>report</b>(What,Data) -&gt;
<a name="1417"/> 1417:     case What of
<a name="1418"/> 1418: 	loginfo -&gt;
<a name="1419"/> 1419: 	    %% logfiles and direcories have been created for a test and the
<a name="1420"/> 1420: 	    %% top level test index page needs to be refreshed
<a name="1421"/> 1421: 	    TestName = filename:basename(?val(topdir, Data), &quot;.logs&quot;),
<a name="1422"/> 1422: 	    RunDir = ?val(rundir, Data),
<a name="1423"/> 1423: 	    _ = ct_logs:make_all_suites_index({TestName,RunDir}),
<a name="1424"/> 1424: 	    ok;
<a name="1425"/> 1425: 	tests_start -&gt;
<a name="1426"/> 1426: 	    ok;
<a name="1427"/> 1427: 	tests_done -&gt;
<a name="1428"/> 1428: 	    ok;
<a name="1429"/> 1429: 	severe_error -&gt;
<a name="1430"/> 1430: 	    ct_event:sync_notify(#event{name=What,
<a name="1431"/> 1431: 					node=node(),
<a name="1432"/> 1432: 					data=Data}),
<a name="1433"/> 1433: 	    ct_util:set_testdata({What,Data}),
<a name="1434"/> 1434: 	    ok;
<a name="1435"/> 1435: 	tc_start -&gt;
<a name="1436"/> 1436: 	    %% Data = {{Suite,{Func,GroupName}},LogFileName}
<a name="1437"/> 1437: 	    Data1 = case Data of
<a name="1438"/> 1438: 			{{Suite,{Func,undefined}},LFN} -&gt; {{Suite,Func},LFN};
<a name="1439"/> 1439: 			_ -&gt; Data
<a name="1440"/> 1440: 		    end,
<a name="1441"/> 1441: 	    ct_event:sync_notify(#event{name=tc_logfile,
<a name="1442"/> 1442: 					node=node(),
<a name="1443"/> 1443: 					data=Data1}),
<a name="1444"/> 1444: 	    ok;
<a name="1445"/> 1445: 	tc_done -&gt;
<a name="1446"/> 1446: 	    {Suite,{Func,GrName},Result} = Data,
<a name="1447"/> 1447:             FuncSpec = if GrName == undefined -&gt; Func;
<a name="1448"/> 1448:                           true                -&gt; {Func,GrName}
<a name="1449"/> 1449:                        end,
<a name="1450"/> 1450: 	    %% Register the group leader for the process calling the report
<a name="1451"/> 1451: 	    %% function, making it possible for a hook function to print
<a name="1452"/> 1452: 	    %% in the test case log file
<a name="1453"/> 1453: 	    ReportingPid = self(),
<a name="1454"/> 1454: 	    ct_logs:register_groupleader(ReportingPid, group_leader()),
<a name="1455"/> 1455: 	    case Result of
<a name="1456"/> 1456: 		{failed, Reason} -&gt;
<a name="1457"/> 1457: 		    ct_hooks:on_tc_fail(What, {Suite,FuncSpec,Reason});
<a name="1458"/> 1458: 		{skipped,{failed,{_,init_per_testcase,_}}=Reason} -&gt;
<a name="1459"/> 1459: 		    ct_hooks:on_tc_skip(tc_auto_skip,  {Suite,FuncSpec,Reason});
<a name="1460"/> 1460: 		{skipped,{require_failed,_}=Reason} -&gt;
<a name="1461"/> 1461: 		    ct_hooks:on_tc_skip(tc_auto_skip, {Suite,FuncSpec,Reason});
<a name="1462"/> 1462: 		{skipped,Reason} -&gt;
<a name="1463"/> 1463: 		    ct_hooks:on_tc_skip(tc_user_skip, {Suite,FuncSpec,Reason});
<a name="1464"/> 1464: 		{auto_skipped,Reason} -&gt;
<a name="1465"/> 1465: 		    ct_hooks:on_tc_skip(tc_auto_skip, {Suite,FuncSpec,Reason});
<a name="1466"/> 1466: 		_Else -&gt;
<a name="1467"/> 1467: 		    ok
<a name="1468"/> 1468: 	    end,
<a name="1469"/> 1469: 	    ct_logs:unregister_groupleader(ReportingPid),
<a name="1470"/> 1470: 	    case {Func,Result} of
<a name="1471"/> 1471: 		{error_in_suite,_} when Suite == ?MODULE -&gt;
<a name="1472"/> 1472: 		    ok;
<a name="1473"/> 1473: 		{init_per_suite,_} -&gt;
<a name="1474"/> 1474: 		    ok;
<a name="1475"/> 1475: 		{end_per_suite,_} -&gt;
<a name="1476"/> 1476: 		    ok;
<a name="1477"/> 1477: 		{init_per_group,_} -&gt;
<a name="1478"/> 1478: 		    ok;
<a name="1479"/> 1479: 		{end_per_group,_} -&gt;
<a name="1480"/> 1480: 		    ok;
<a name="1481"/> 1481: 		{_,ok} -&gt;
<a name="1482"/> 1482: 		    add_to_stats(ok);
<a name="1483"/> 1483: 		{_,{skipped,{failed,{_,init_per_testcase,_}}}} -&gt;
<a name="1484"/> 1484: 		    add_to_stats(auto_skipped);
<a name="1485"/> 1485: 		{_,{skipped,{require_failed,_}}} -&gt;
<a name="1486"/> 1486: 		    add_to_stats(auto_skipped);
<a name="1487"/> 1487: 		{_,{skipped,{timetrap_error,_}}} -&gt;
<a name="1488"/> 1488: 		    add_to_stats(auto_skipped);
<a name="1489"/> 1489: 		{_,{skipped,{invalid_time_format,_}}} -&gt;
<a name="1490"/> 1490: 		    add_to_stats(auto_skipped);
<a name="1491"/> 1491: 		{_,{skipped,_}} -&gt;
<a name="1492"/> 1492: 		    add_to_stats(user_skipped);
<a name="1493"/> 1493: 		{_,{auto_skipped,_}} -&gt;
<a name="1494"/> 1494: 		    add_to_stats(auto_skipped);
<a name="1495"/> 1495: 		{_,{SkipOrFail,_Reason}} -&gt;
<a name="1496"/> 1496: 		    add_to_stats(SkipOrFail)
<a name="1497"/> 1497: 	    end;
<a name="1498"/> 1498: 	tc_user_skip -&gt;
<a name="1499"/> 1499: 	    %% test case or config function specified as skipped in testspec,
<a name="1500"/> 1500: 	    %% or init config func for suite/group has returned {skip,Reason}
<a name="1501"/> 1501: 	    %% Data = {Suite,{Func,GroupName},Comment}
<a name="1502"/> 1502: 	    {Func,Data1} = case Data of
<a name="1503"/> 1503: 			       {Suite,{F,undefined},Comment} -&gt;
<a name="1504"/> 1504: 				   {F,{Suite,F,Comment}};
<a name="1505"/> 1505: 			       D = {_,{F,_},_} -&gt;
<a name="1506"/> 1506: 				   {F,D}
<a name="1507"/> 1507: 			   end,
<a name="1508"/> 1508: 	    ct_event:sync_notify(#event{name=tc_user_skip,
<a name="1509"/> 1509: 					node=node(),
<a name="1510"/> 1510: 					data=Data1}),
<a name="1511"/> 1511: 	    ct_hooks:on_tc_skip(What, Data1),
<a name="1512"/> 1512: 	    if Func /= init_per_suite, Func /= init_per_group,
<a name="1513"/> 1513: 	       Func /= end_per_suite, Func /= end_per_group -&gt;
<a name="1514"/> 1514: 		    add_to_stats(user_skipped);
<a name="1515"/> 1515: 	       true -&gt;
<a name="1516"/> 1516: 		    ok
<a name="1517"/> 1517: 	    end;
<a name="1518"/> 1518: 	tc_auto_skip -&gt;
<a name="1519"/> 1519: 	    %% test case skipped because of error in config function, or
<a name="1520"/> 1520: 	    %% config function skipped because of error in info function
<a name="1521"/> 1521: 	    %% Data = {Suite,{Func,GroupName},Comment}
<a name="1522"/> 1522: 	    {Func,Data1} = case Data of
<a name="1523"/> 1523: 			       {Suite,{F,undefined},Comment} -&gt;
<a name="1524"/> 1524: 				   {F,{Suite,F,Comment}};
<a name="1525"/> 1525: 			       D = {_,{F,_},_} -&gt;
<a name="1526"/> 1526: 				   {F,D}
<a name="1527"/> 1527: 			   end,
<a name="1528"/> 1528: 	    %% this test case does not have a log, so printouts
<a name="1529"/> 1529: 	    %% from event handlers should end up in the main log
<a name="1530"/> 1530: 	    ct_event:sync_notify(#event{name=tc_auto_skip,
<a name="1531"/> 1531: 					node=node(),
<a name="1532"/> 1532: 					data=Data1}),
<a name="1533"/> 1533: 	    ct_hooks:on_tc_skip(What, Data1),
<a name="1534"/> 1534: 	    if Func /= end_per_suite, 
<a name="1535"/> 1535: 	       Func /= end_per_group -&gt;
<a name="1536"/> 1536: 		    add_to_stats(auto_skipped);
<a name="1537"/> 1537: 	       true -&gt; 
<a name="1538"/> 1538: 		    ok
<a name="1539"/> 1539: 	    end;
<a name="1540"/> 1540: 	framework_error -&gt;
<a name="1541"/> 1541: 	    case Data of
<a name="1542"/> 1542: 		{{M,F},E} -&gt;
<a name="1543"/> 1543: 		    ct_event:sync_notify(#event{name=tc_done,
<a name="1544"/> 1544: 						node=node(),
<a name="1545"/> 1545: 						data={M,F,{framework_error,E}}});
<a name="1546"/> 1546: 		_ -&gt;
<a name="1547"/> 1547: 		    ct_event:sync_notify(#event{name=tc_done,
<a name="1548"/> 1548: 						node=node(),
<a name="1549"/> 1549: 						data=Data})
<a name="1550"/> 1550: 	    end;
<a name="1551"/> 1551: 	_ -&gt;
<a name="1552"/> 1552: 	    ok
<a name="1553"/> 1553:     end,
<a name="report-last_expr"/><a name="1554"/> 1554: <b>    catch vts:report</b>(What,Data).
<a name="1555"/> 1555: 
<a name="add_to_stats-1"/><a name="1556"/> 1556: <b>add_to_stats</b>(Result) -&gt;
<a name="1557"/> 1557:     Update = fun({Ok,Failed,Skipped={UserSkipped,AutoSkipped}}) -&gt;
<a name="1558"/> 1558: 		     Stats =
<a name="1559"/> 1559: 			 case Result of
<a name="1560"/> 1560: 			     ok -&gt;
<a name="1561"/> 1561: 				 {Ok+1,Failed,Skipped};
<a name="1562"/> 1562: 			     failed -&gt;
<a name="1563"/> 1563: 				 {Ok,Failed+1,Skipped};
<a name="1564"/> 1564: 			     skipped -&gt;
<a name="1565"/> 1565: 				 {Ok,Failed,{UserSkipped+1,AutoSkipped}};
<a name="1566"/> 1566: 			     user_skipped -&gt;
<a name="1567"/> 1567: 				 {Ok,Failed,{UserSkipped+1,AutoSkipped}};
<a name="1568"/> 1568: 			     auto_skipped -&gt;
<a name="1569"/> 1569: 				 {Ok,Failed,{UserSkipped,AutoSkipped+1}}
<a name="1570"/> 1570: 			 end,
<a name="1571"/> 1571: 		     ct_event:sync_notify(#event{name=test_stats,
<a name="1572"/> 1572: 						 node=node(),
<a name="1573"/> 1573: 						 data=Stats}),
<a name="1574"/> 1574: 		     Stats
<a name="1575"/> 1575: 	     end,
<a name="add_to_stats-last_expr"/><a name="1576"/> 1576: <b>    ct_util:update_testdata</b>(stats, Update).
<a name="1577"/> 1577: 
<a name="1578"/> 1578: <i>%%%-----------------------------------------------------------------</i>
<a name="1579"/> 1579: <i>%%% -spec warn(What) -&gt; true | false</i>
<a name="warn-1"/><a name="1580"/> 1580: <b>warn</b>(What) when What==nodes; What==processes -&gt;
<a name="1581"/> 1581:     false;
<a name="1582"/> 1582: <b>warn</b>(_What) -&gt;
<a name="warn-last_expr"/><a name="1583"/> 1583:     true.
<a name="1584"/> 1584: 
<a name="1585"/> 1585: <i>%%%-----------------------------------------------------------------</i>
<a name="1586"/> 1586: <i>%%% -spec add_data_dir(File0, Config) -&gt; File1</i>
<a name="add_data_dir-2"/><a name="1587"/> 1587: <b>add_data_dir</b>(File,Config) when is_atom(File) -&gt;
<a name="1588"/> 1588:     add_data_dir(atom_to_list(File),Config);
<a name="1589"/> 1589: 
<a name="1590"/> 1590: <b>add_data_dir</b>(File,Config) when is_list(File) -&gt;
<a name="add_data_dir-last_expr"/><a name="1591"/> 1591: <b>    case filename:split</b>(File) of
<a name="1592"/> 1592: 	[File] -&gt;
<a name="1593"/> 1593: 	    %% no user path, add data dir
<a name="1594"/> 1594: 	    case lists:keysearch(data_dir,1,Config) of
<a name="1595"/> 1595: 		{value,{data_dir,DataDir}} -&gt;
<a name="1596"/> 1596: 		    filename:join(DataDir,File);
<a name="1597"/> 1597: 		_ -&gt;
<a name="1598"/> 1598: 		    File
<a name="1599"/> 1599: 	    end;
<a name="1600"/> 1600: 	_ -&gt;
<a name="1601"/> 1601: 	    File
<a name="1602"/> 1602:     end.
<a name="1603"/> 1603: 
<a name="1604"/> 1604: <i>%%%-----------------------------------------------------------------</i>
<a name="1605"/> 1605: <i>%%% -spec get_logopts() -&gt; [LogOpt]</i>
<a name="get_logopts-0"/><a name="1606"/> 1606: <b>get_logopts</b>() -&gt;
<a name="get_logopts-last_expr"/><a name="1607"/> 1607: <b>    case ct_util:get_testdata</b>(logopts) of
<a name="1608"/> 1608: 	undefined -&gt;
<a name="1609"/> 1609: 	    [];
<a name="1610"/> 1610: 	LogOpts -&gt;
<a name="1611"/> 1611: 	    LogOpts
<a name="1612"/> 1612:     end.
<a name="1613"/> 1613: 
<a name="1614"/> 1614: <i>%%%-----------------------------------------------------------------</i>
<a name="1615"/> 1615: <i>%%% -spec format_comment(Comment) -&gt; HtmlComment</i>
<a name="format_comment-1"/><a name="1616"/> 1616: <b>format_comment</b>(Comment) -&gt;
<a name="format_comment-last_expr"/><a name="1617"/> 1617:     &quot;&lt;font color=\&quot;green\&quot;&gt;&quot; ++ Comment ++ &quot;&lt;/font&gt;&quot;.
<a name="1618"/> 1618: 
<a name="1619"/> 1619: <i>%%%-----------------------------------------------------------------</i>
<a name="1620"/> 1620: <i>%%% -spec get_html_wrapper(TestName, PrintLabel, Cwd) -&gt; Header</i>
<a name="get_html_wrapper-4"/><a name="1621"/> 1621: <b>get_html_wrapper</b>(TestName, PrintLabel, Cwd, TableCols) -&gt;
<a name="get_html_wrapper-last_expr"/><a name="1622"/> 1622: <b>    get_html_wrapper</b>(TestName, PrintLabel, Cwd, TableCols, utf8).
<a name="1623"/> 1623: 
<a name="get_html_wrapper-5"/><a name="1624"/> 1624: <b>get_html_wrapper</b>(TestName, PrintLabel, Cwd, TableCols, Encoding) -&gt;
<a name="get_html_wrapper-last_expr"/><a name="1625"/> 1625: <b>    ct_logs:get_ts_html_wrapper</b>(TestName, PrintLabel, Cwd, TableCols, Encoding).
<a name="1626"/> 1626: 
<a name="1627"/> 1627: <i>%%%-----------------------------------------------------------------</i>
<a name="1628"/> 1628: <i>%%% -spec get_log_dir() -&gt; {ok,LogDir}</i>
<a name="get_log_dir-0"/><a name="1629"/> 1629: <b>get_log_dir</b>() -&gt;
<a name="get_log_dir-last_expr"/><a name="1630"/> 1630: <b>    ct_logs:get_log_dir</b>(true).
<a name="1631"/> 1631: 
<a name="1632"/> 1632: <i>%%%-----------------------------------------------------------------</i>
<a name="1633"/> 1633: <i>%%% Call all and group callbacks and post_* hooks with error handling</i>
<a name="safe_apply_all_0-1"/><a name="1634"/> 1634: <b>safe_apply_all_0</b>(Mod) -&gt;
<a name="safe_apply_all_0-last_expr"/><a name="1635"/> 1635: <b>    try apply</b>(Mod, all, []) of
<a name="1636"/> 1636:         AllTCs0 when is_list(AllTCs0) -&gt;
<a name="1637"/> 1637: 	    try save_seqs(Mod,AllTCs0) of
<a name="1638"/> 1638: 		SeqsAndTCs when is_list(SeqsAndTCs) -&gt;
<a name="1639"/> 1639:                     all_hook(Mod,SeqsAndTCs)
<a name="1640"/> 1640:             catch throw:{error,What} -&gt;
<a name="1641"/> 1641: 		    {error,What}
<a name="1642"/> 1642:             end;
<a name="1643"/> 1643:         {skip,_}=Skip -&gt;
<a name="1644"/> 1644:             all_hook(Mod,Skip);
<a name="1645"/> 1645:         Bad -&gt;
<a name="1646"/> 1646:             {error,{bad_return,Bad}}
<a name="1647"/> 1647:     catch
<a name="1648"/> 1648:         _:Reason:Stacktrace -&gt;
<a name="1649"/> 1649:             handle_callback_crash(Reason,Stacktrace,Mod,all,{error,undef})
<a name="1650"/> 1650:     end.
<a name="1651"/> 1651: 
<a name="all_hook-2"/><a name="1652"/> 1652: <b>all_hook</b>(Mod, All) -&gt;
<a name="all_hook-last_expr"/><a name="1653"/> 1653: <b>    case ct_hooks:all</b>(Mod, All) of
<a name="1654"/> 1654:         AllTCs when is_list(AllTCs) -&gt;
<a name="1655"/> 1655:             {ok,AllTCs};
<a name="1656"/> 1656:         {skip,_}=Skip -&gt;
<a name="1657"/> 1657:             Skip;
<a name="1658"/> 1658:         {fail,Reason} -&gt;
<a name="1659"/> 1659:             {error,Reason};
<a name="1660"/> 1660:         Bad -&gt;
<a name="1661"/> 1661:             {error,{bad_hook_return,Bad}}
<a name="1662"/> 1662:     end.
<a name="1663"/> 1663: 
<a name="safe_apply_groups_0-2"/><a name="1664"/> 1664: <b>safe_apply_groups_0</b>(Mod,Default) -&gt;
<a name="safe_apply_groups_0-last_expr"/><a name="1665"/> 1665: <b>    try apply</b>(Mod, groups, []) of
<a name="1666"/> 1666:         GroupDefs when is_list(GroupDefs) -&gt;
<a name="1667"/> 1667:             case ct_hooks:groups(Mod, GroupDefs) of
<a name="1668"/> 1668:                 GroupDefs1 when is_list(GroupDefs1) -&gt;
<a name="1669"/> 1669:                     {ok,GroupDefs1};
<a name="1670"/> 1670:                 {fail,Reason} -&gt;
<a name="1671"/> 1671:                     {error,Reason};
<a name="1672"/> 1672:                 Bad -&gt;
<a name="1673"/> 1673:                     {error,{bad_hook_return,Bad}}
<a name="1674"/> 1674:             end;
<a name="1675"/> 1675:         Bad -&gt;
<a name="1676"/> 1676:             {error,{bad_return,Bad}}
<a name="1677"/> 1677:     catch
<a name="1678"/> 1678:         _:Reason:Stacktrace -&gt;
<a name="1679"/> 1679:             handle_callback_crash(Reason,Stacktrace,Mod,groups,Default)
<a name="1680"/> 1680:     end.
<a name="1681"/> 1681: 
<a name="handle_callback_crash-5"/><a name="1682"/> 1682: <b>handle_callback_crash</b>(undef,[{Mod,Func,[],_}|_],Mod,Func,Default) -&gt;
<a name="1683"/> 1683:     case ct_hooks:Func(Mod, []) of
<a name="1684"/> 1684:         [] -&gt;
<a name="1685"/> 1685:             Default;
<a name="1686"/> 1686:         List when is_list(List) -&gt;
<a name="1687"/> 1687:             {ok,List};
<a name="1688"/> 1688:         {fail,Reason} -&gt;
<a name="1689"/> 1689:             {error,Reason};
<a name="1690"/> 1690:         Bad -&gt;
<a name="1691"/> 1691:             {error,{bad_hook_return,Bad}}
<a name="1692"/> 1692:     end;
<a name="1693"/> 1693: <b>handle_callback_crash</b>(Reason,Stacktrace,_Mod,_Func,_Default) -&gt;
<a name="handle_callback_crash-last_expr"/><a name="1694"/> 1694:     {error,{failed,{Reason,Stacktrace}}}.
<a name="1695"/> 1695: 
<a name="expand_tests-2"/><a name="1696"/> 1696: <b>expand_tests</b>(Mod, [{testcase,Case,[Prop]}|Tests]) -&gt;
<a name="1697"/> 1697:     [{repeat,{Mod,Case},Prop}|expand_tests(Mod,Tests)];
<a name="1698"/> 1698: <b>expand_tests</b>(Mod,[Test|Tests]) -&gt;
<a name="1699"/> 1699:     [Test|expand_tests(Mod,Tests)];
<a name="1700"/> 1700: <b>expand_tests</b>(_Mod,[]) -&gt;
<a name="expand_tests-last_expr"/><a name="1701"/> 1701:     [].
</pre>
</body>
</html>
